    
# base/argocd/allow-argocd-traffic.yaml
---
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-argocd-core-traffic
  namespace: argocd
spec:
  description: "Allow core traffic for ArgoCD: API Server, intra-component, and kubelet probes"

  # Applique cette politique à TOUS les pods du namespace argocd
  endpointSelector: {}

  # --- RÈGLES ENTRANTES (INGRESS) ---
  # Le point crucial que nous avons manqué
  ingress:
    # 1. Autoriser le trafic depuis d'autres pods ArgoCD dans le même namespace
    - fromEndpoints:
        - matchLabels: {} # {} = Tous les endpoints DANS ce namespace

    # 2. AUTORISER LES SONDES DU KUBELET (healthz)
    #    C'est ce qui corrigera votre erreur "connection refused" sur le port 8082
    - fromEntities:
        - host

  # --- RÈGLES SORTANTES (EGRESS) ---
  egress:
    # 1. Autoriser le trafic vers d'autres pods ArgoCD dans le même namespace
    - toEndpoints:
        - matchLabels: {} # {} = Tous les endpoints DANS ce namespace

    # 2. AUTORISER L'ACCÈS À L'API SERVER (port 6443)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-apiserver

    # 3. Autoriser l'accès au DNS (CoreDNS)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY
          rules:
            dns:
              - matchPattern: "*"
