# base/longhorn/ingress.yaml

# --- OBJET 1 : La commande du certificat à cert-manager ---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: longhorn-ui-cert
  # Le certificat doit vivre dans le namespace de Longhorn
  namespace: longhorn-system
spec:
  # Le nom du Secret où le certificat sera stocké
  secretName: longhorn-ui-tls
  
  # Le nom de domaine pour le certificat
  dnsNames:
  - longhorn.truxonline.com # Adaptez si vous souhaitez une autre URL
  
  # L'issuer que cert-manager doit utiliser
  issuerRef:
    name: letsencrypt-gandi-prod
    kind: ClusterIssuer
---
# --- OBJET 2 : La route d'entrée pour Traefik ---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: longhorn-ui-route
  namespace: longhorn-system
spec:
  entryPoints:
    - websecure
  routes:
  - match: Host(`longhorn.truxonline.com`)
    kind: Rule
    services:
    - name: longhorn-frontend # Le nom du service de l'UI Longhorn
      kind: Service
      port: 80 # Le port HTTP du service Longhorn
  tls:
    # On dit à Traefik d'utiliser le Secret créé par cert-manager
    secretName: longhorn-ui-tls
