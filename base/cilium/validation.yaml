# base/cilium/validation.yaml
---
# Job de validation pour vÃ©rifier que Cilium fonctionne correctement
apiVersion: batch/v1
kind: Job
metadata:
  name: cilium-validation
  namespace: kube-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: cilium-check
        image: quay.io/cilium/cilium:v1.18.1
        command:
        - /bin/bash
        - -c
        - |
          echo "ğŸ” Validation Cilium post-migration"
          set -e
          
          # VÃ©rifier le status Cilium
          echo "ğŸ“Š Status Cilium:"
          cilium status --brief
          
          # VÃ©rifier la connectivitÃ©
          echo "ğŸ”Œ Test connectivitÃ©:"
          cilium-health status
          
          # VÃ©rifier Hubble
          echo "ğŸ“¡ VÃ©rification Hubble:"
          hubble status
          
          echo "âœ… Validation Cilium rÃ©ussie"
        securityContext:
          privileged: true
      restartPolicy: Never
      tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
      serviceAccountName: cilium
