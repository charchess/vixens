#!/bin/bash
set -euo pipefail

K_NAMESPACE_FILE="${HOME}/.k_namespace"
K_ENV_FILE="${HOME}/.k_env"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

init() {
    ENV=$(current_env)
    KUBECONFIG=~/vixens/kubeconfig-$ENV
    NS=$(current_ns)
}

# ── Helpers ────────────────────────────────────────────────────────────

current_ns() {
  [[ -f "$K_NAMESPACE_FILE" ]] && cat "$K_NAMESPACE_FILE" || echo "default"
}

current_env() {
  [[ -f "$K_ENV_FILE" ]] && cat "$K_ENV_FILE" || echo "dev"
}

save_ns() {
  local ns="$1"
  if kubectl get namespace "$ns" &>/dev/null; then
    echo "$ns" > "$K_NAMESPACE_FILE"
    echo -e "${GREEN}Namespace défini → $ns${NC}"
  else
    echo -e "${RED}Namespace inconnu : $ns${NC}" >&2
    exit 1
  fi
}

save_env() {
  local env="$1"
  if [[ "$env" == "prod" || "$env" == "dev" ]]; then
    echo "$env" > "$K_ENV_FILE"
    echo -e "${GREEN}Environnement défini → $env${NC}"
  else
    echo -e "${RED}Environnement inconnu : $env${NC}" >&2
    exit 1
  fi
}

init

# ── Commands ────────────────────────────────────────────────────────────

case "${1:-}" in
  "")
    echo -e "[ns: ${GREEN}$NS${NC}] [env: ${GREEN}$ENV${NC}] "
  ;;
  ns)
    [[ -z "${2:-}" ]] && { echo -e "${RED}Usage: k set <namespace>${NC}" >&2; exit 1; }
    save_ns "$2"
    ;;
  env)
    [[ -z "${2:-}" ]] && { echo -e "${RED}Usage: k env <dev/prod>${NC}" >&2; exit 1; }
    save_env "$2"
    ;;
  reset)
    rm -f "$K_NAMESPACE_FILE"
    echo -e "${YELLOW}Namespace réinitialisé → default${NC}"
    ;;
  --dry-run)
    shift
    echo -e "${YELLOW}[dry-run] kubectl -n $(current_ns) $*${NC}"
    ;;
  *)
    ENV=$(current_env)
    KUBECONFIG=~/vixens/kubeconfig-$ENV
    NS=$(current_ns)
    echo -e "[ns: ${GREEN}$NS${NC}] [env: ${GREEN}$ENV${NC}] kubectl $*" >&2
    kubectl "$@" -n "$NS"
    ;;
esac

