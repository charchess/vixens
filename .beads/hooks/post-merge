#!/usr/bin/env sh
# Custom post-merge hook for beads with Dolt backend
# Workaround for https://github.com/steveyegge/beads/issues/1771

if ! command -v bd >/dev/null 2>&1; then
    exit 0
fi

echo "üîÑ Syncing beads issues..."

# Get the latest issues.jsonl from beads-sync
LATEST_JSONL=$(mktemp)
git show origin/beads-sync:.beads/issues.jsonl > "$LATEST_JSONL" 2>/dev/null || exit 0

# Count issues in JSONL
REMOTE_COUNT=$(wc -l < "$LATEST_JSONL" 2>/dev/null || echo 0)

# Get local issue count
LOCAL_COUNT=$(bd status 2>/dev/null | grep "Total Issues" | awk '{print $3}' || echo 0)

if [ "$REMOTE_COUNT" != "$LOCAL_COUNT" ]; then
    echo "üì• Sync needed: local=$LOCAL_COUNT, remote=$REMOTE_COUNT"
    
    # Get list of local issue IDs
    LOCAL_IDS=$(bd list --limit 0 --json 2>/dev/null | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | sort -u)
    
    # Create temp file with only new issues
    NEW_JSONL=$(mktemp)
    while IFS= read -r line; do
        ISSUE_ID=$(echo "$line" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
        if ! echo "$LOCAL_IDS" | grep -q "^${ISSUE_ID}$"; then
            echo "$line" >> "$NEW_JSONL"
        fi
    done < "$LATEST_JSONL"
    
    NEW_COUNT=$(wc -l < "$NEW_JSONL" 2>/dev/null || echo 0)
    
    if [ "$NEW_COUNT" -gt 0 ]; then
        echo "üì• Importing $NEW_COUNT new issues..."
        bd import -i "$NEW_JSONL" 2>/dev/null || echo "‚ö†Ô∏è Import had issues, but continuing..."
    fi
    
    rm -f "$NEW_JSONL"
    echo "‚úÖ Sync complete"
else
    echo "‚úÖ Already in sync ($LOCAL_COUNT issues)"
fi

rm -f "$LATEST_JSONL"
