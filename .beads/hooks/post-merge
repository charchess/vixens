#!/usr/bin/env sh
# Custom post-merge hook for beads with Dolt backend
# Workaround for https://github.com/steveyegge/beads/issues/1771

if ! command -v bd >/dev/null 2>&1; then
    exit 0
fi

echo "ðŸ”„ Syncing beads issues..."

# Get the latest issues.jsonl from beads-sync
LATEST_JSONL=$(mktemp)
git show origin/beads-sync:.beads/issues.jsonl > "$LATEST_JSONL" 2>/dev/null || exit 0

# Compare checksums to detect ANY changes (not just count)
LOCAL_HASH=$(sha256sum .beads/issues.jsonl 2>/dev/null | cut -d' ' -f1)
REMOTE_HASH=$(sha256sum "$LATEST_JSONL" 2>/dev/null | cut -d' ' -f1)

if [ "$LOCAL_HASH" = "$REMOTE_HASH" ]; then
    echo "âœ… Already in sync"
    rm -f "$LATEST_JSONL"
    exit 0
fi

# Count issues
REMOTE_COUNT=$(wc -l < "$LATEST_JSONL" 2>/dev/null || echo 0)
LOCAL_COUNT=$(bd status 2>/dev/null | grep "Total Issues" | awk '{print $3}' || echo 0)

echo "ðŸ“¥ Sync needed: local=$LOCAL_COUNT, remote=$REMOTE_COUNT (content changed)"

# Full reimport is safer than partial with Dolt backend
cp "$LATEST_JSONL" .beads/issues.jsonl
rm -rf .beads/dolt
bd init --prefix vixens --skip-hooks 2>/dev/null
bd config set sync.branch beads-sync
bd config set sync.remote origin
bd import -i .beads/issues.jsonl 2>/dev/null

echo "âœ… Synced $REMOTE_COUNT issues"

rm -f "$LATEST_JSONL"
