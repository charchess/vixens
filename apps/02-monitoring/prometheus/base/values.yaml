---
# Prometheus standalone configuration

# Server configuration
server:
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  persistentVolume:
    enabled: true
    storageClass: synelia-iscsi-retain
    size: 50Gi
  retention: 30d
  resources:
    requests:
      cpu: 300m
      memory: 1Gi
    limits:
      memory: 2Gi

# Extra scrape configurations for annotated pods
extraScrapeConfigs: |
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name

# Alertmanager configuration
alertmanager:
  enabled: true
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  persistentVolume:
    enabled: true
    storageClass: synelia-iscsi-retain
    size: 10Gi
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 512Mi
  extraVolumes:
    - name: alertmanager-secrets
      secret:
        secretName: alertmanager-secrets
  extraVolumeMounts:
    - name: alertmanager-secrets
      mountPath: /etc/alertmanager-secrets
      readOnly: true
  extraEnv:
    - name: DISCORD_WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: alertmanager-secrets
          key: DISCORD_WEBHOOK_URL
          optional: true
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by:
        - alertname
        - cluster
        - service
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: discord-notifications
      routes:
        - match:
            severity: critical
          receiver: discord-notifications
    receivers:
      - name: discord-notifications
        slack_configs:
          - api_url_file: /etc/alertmanager-secrets/DISCORD_WEBHOOK_URL
            channel: '#alerts'
            send_resolved: true
# Node exporter
nodeExporter:
  enabled: true
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  hostNetwork: true
  hostPID: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
# Pushgateway subchart (disabled - réactiver si CronJobs/batch jobs nécessaires)
prometheus-pushgateway:
  enabled: false
# Kube-state-metrics subchart (metrics on Kubernetes objects)
kube-state-metrics:
  enabled: true
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
