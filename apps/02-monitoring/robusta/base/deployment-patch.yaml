apiVersion: apps/v1
kind: Deployment
metadata:
  name: robusta-runner
spec:
  template:
    spec:
      initContainers:
        - name: config-interpolator
          image: alpine:3.23
          command: ["sh", "-c"]
          args:
            - |
              apk add --no-cache gettext
              echo "Interpolating Robusta config..."
              envsubst < /config-template/active_playbooks.yaml.tmpl > /config-final/active_playbooks.yaml
              echo "Done."
          envFrom:
            - secretRef:
                name: robusta-secrets
          volumeMounts:
            - name: config-template
              mountPath: /config-template
            - name: config-final
              mountPath: /config-final
      containers:
        - name: runner
          env:
            - name: PLAYBOOKS_CONFIG_FILE_PATH
              value: "/etc/robusta/config/active_playbooks.yaml"
          volumeMounts:
            - name: config-final
              mountPath: /etc/robusta/config/active_playbooks.yaml
              subPath: active_playbooks.yaml
      volumes:
        - name: config-template
          configMap:
            name: robusta-config-template
        - name: config-final
          emptyDir: {}