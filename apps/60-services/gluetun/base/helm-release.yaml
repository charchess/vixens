apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gluetun
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: latest
            env:
              # -- VPN Service Provider
              VPN_SERVICE_PROVIDER: "nordvpn"
              VPN_TYPE: "wireguard"
              
              # -- Wireguard credentials from the Infisical-managed secret
              WIREGUARD_PRIVATE_KEY:
                valueFrom:
                  secretKeyRef:
                    name: gluetun-wireguard-secrets
                    key: WIREGUARD_PRIVATE_KEY
              WIREGUARD_ADDRESSES:
                valueFrom:
                  secretKeyRef:
                    name: gluetun-wireguard-secrets
                    key: WIREGUARD_ADDRESSES

              # -- VPN server location
              SERVER_COUNTRIES: "Switzerland"
              
              # -- Timezone
              TZ: "Etc/UTC"

              # -- Firewall settings to allow access from other pods in the cluster
              # Allows access to the HTTP and SOCKS5 proxies from any pod on the cluster's internal network
              FIREWALL_VPN_INPUT_PORTS: "8888,1080"

            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
    
    service:
      main:
        ports:
          http-proxy:
            port: 8888
            protocol: TCP
          socks5-proxy:
            port: 1080
            protocol: TCP
