---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: networking

resources:
  - ../../base

helmCharts:
  - name: netbird
    releaseName: netbird
    version: 1.8.2
    repo: https://totmicro.github.io/helms
    namespace: networking
    includeCRDs: false
    valuesInline:
      management:
        enabled: true
        replicaCount: 1
        strategy:
          type: Recreate
        image:
          repository: netbirdio/management
          tag: "0.32.0"
          pullPolicy: IfNotPresent
        
        # Persistent storage for SQLite database
        volumes:
          - name: netbird-data
            persistentVolumeClaim:
              claimName: netbird-data
        volumeMounts:
          - name: netbird-data
            mountPath: /var/lib/netbird
        
        envRaw:
          - name: NETBIRD_STORE_ENGINE
            value: "sqlite"
          - name: NETBIRD_DATADIR
            value: "/var/lib/netbird"
          - name: NETBIRD_MGMT_API_ENDPOINT
            value: "https://netbird-api.dev.truxonline.com"
          - name: NETBIRD_MGMT_GRPC_ENDPOINT
            value: "netbird-management:443"
          - name: NETBIRD_SIGNAL_ENDPOINT
            value: "https://netbird-signal.dev.truxonline.com:443"
          - name: NETBIRD_RELAY_ENDPOINT
            value: "https://netbird-relay.dev.truxonline.com:443"
          - name: NETBIRD_TURN_SERVER_ADDRESS
            value: "turn:netbird-turn.dev.truxonline.com:3478"
          - name: NETBIRD_TURN_SECRET
            valueFrom:
              secretKeyRef:
                name: netbird-secrets
                key: TURN_SECRET
        ingress:
          enabled: true
          className: traefik
          hosts:
            - host: netbird-api.dev.truxonline.com
              paths:
                - path: /
                  pathType: ImplementationSpecific
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-staging
          tls:
            - secretName: netbird-api-tls
              hosts:
                - netbird-api.dev.truxonline.com
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      
      signal:
        enabled: true
        replicaCount: 1
        image:
          repository: netbirdio/signal
          tag: "0.32.0"
          pullPolicy: IfNotPresent
        ingress:
          enabled: true
          className: traefik
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-staging
          hosts:
            - host: netbird-signal.dev.truxonline.com
              paths:
                - path: /signalexchange.SignalExchange
                  pathType: ImplementationSpecific
          tls:
            - secretName: netbird-signal-tls
              hosts:
                - netbird-signal.dev.truxonline.com
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m
      
      relay:
        enabled: true
        replicaCount: 1
        image:
          repository: netbirdio/relay
          tag: "0.32.0"
          pullPolicy: IfNotPresent
        envRaw:
          - name: NETBIRD_RELAY_SECRET
            valueFrom:
              secretKeyRef:
                name: netbird-secrets
                key: RELAY_SECRET
        ingress:
          enabled: true
          className: traefik
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-staging
          hosts:
            - host: netbird-relay.dev.truxonline.com
              paths:
                - path: /relay
                  pathType: ImplementationSpecific
          tls:
            - secretName: netbird-relay-tls
              hosts:
                - netbird-relay.dev.truxonline.com
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m
      
      dashboard:
        enabled: true
        replicaCount: 1
        image:
          repository: netbirdio/dashboard
          tag: "v2.22.2"
          pullPolicy: IfNotPresent
        envRaw:
          - name: NETBIRD_MGMT_API_ENDPOINT
            value: "https://netbird-api.dev.truxonline.com"
          - name: NETBIRD_MGMT_GRPC_API_ENDPOINT
            value: "https://netbird-api.dev.truxonline.com"
          - name: AUTH_AUDIENCE
            value: "netbird"
          - name: AUTH_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: netbird-secrets
                key: AUTH_CLIENT_ID
          - name: AUTH_AUTHORITY
            value: "https://authentik.dev.truxonline.com/application/o/netbird/"
          - name: USE_AUTH0
            value: "false"
          - name: AUTH_SUPPORTED_SCOPES
            value: "openid profile email offline_access"
          - name: AUTH_REDIRECT_URI
            value: "https://netbird.dev.truxonline.com"
          - name: AUTH_SILENT_REDIRECT_URI
            value: "https://netbird.dev.truxonline.com/silent-auth"
        ingress:
          enabled: true
          className: traefik
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-staging
            traefik.ingress.kubernetes.io/router.middlewares: networking-redirect-https@kubernetescrd
          hosts:
            - host: netbird.dev.truxonline.com
              paths:
                - path: /
                  pathType: ImplementationSpecific
          tls:
            - secretName: netbird-dashboard-tls
              hosts:
                - netbird.dev.truxonline.com
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m

patches:
  - path: infisical-secret-patch.yaml
    target:
      kind: InfisicalSecret
      name: netbird-secrets-sync
