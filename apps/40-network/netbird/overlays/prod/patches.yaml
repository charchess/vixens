---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netbird-management
spec:
  template:
    spec:
      initContainers:
        - name: init-config
          env:
            - name: AUTH_ISSUER
              value: "https://authentik.truxonline.com/application/o/netbird/"
            - name: AUTH_KEYS_LOCATION
              value: "https://authentik.truxonline.com/application/o/netbird/jwks/"
            - name: AUTH_CLIENT_ID
              value: "netbird"
            - name: AUTH_AUDIENCE
              value: "netbird"
            - name: AUTH_AUTHORIZATION_ENDPOINT
              value: "https://authentik.truxonline.com/application/o/authorize/"
            - name: AUTH_DEVICE_AUTH_ENDPOINT
              value: "https://authentik.truxonline.com/application/o/device/"
            - name: AUTH_TOKEN_ENDPOINT
              value: "https://authentik.truxonline.com/application/o/token/"
            - name: AUTH_OIDC_CONFIG_ENDPOINT
              value: "https://authentik.truxonline.com/application/o/netbird/.well-known/openid-configuration"
      containers:
        - name: management
          env:
            - name: NETBIRD_DOMAIN_NAME
              value: "netbird.truxonline.com"
            - name: NETBIRD_MGMT_API_ENDPOINT
              value: "https://netbird-api.truxonline.com"
            - name: NETBIRD_SIGNAL_ENDPOINT
              value: "https://netbird-signal.truxonline.com"
            - name: NETBIRD_RELAY_ENDPOINT
              value: "https://netbird-relay.truxonline.com"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netbird-relay
spec:
  template:
    spec:
      containers:
        - name: relay
          env:
            - name: NB_RELAY_EXPOSED_ADDRESS
              value: "netbird-relay.truxonline.com:443"
            - name: NETBIRD_RELAY_EXPOSED_ADDRESS
              value: "netbird-relay.truxonline.com:443"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netbird-dashboard
spec:
  template:
    spec:
      containers:
        - name: dashboard
          env:
            - name: AUTH_AUDIENCE
              value: "netbird"
            - name: AUTH_CLIENT_ID
              value: "netbird"
            - name: AUTH_AUTHORITY
              value: "https://authentik.truxonline.com/application/o/netbird/"
            - name: NETBIRD_AUTH_OIDC_CONFIGURATION_ENDPOINT
              value: "https://authentik.truxonline.com/application/o/netbird/.well-known/openid-configuration"
            - name: AUTH_SUPPORTED_SCOPES
              value: "openid profile email offline_access"
            - name: NETBIRD_MGMT_API_ENDPOINT
              value: "https://netbird-api.truxonline.com"
            - name: NETBIRD_MGMT_GRPC_API_ENDPOINT
              value: "https://netbird-api.truxonline.com"
            - name: USE_AUTH0
              value: "false"
---
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: netbird-secrets-sync
  namespace: networking
spec:
  authentication:
    universalAuth:
      secretsScope:
        envSlug: prod