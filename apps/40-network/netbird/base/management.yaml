---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netbird-management
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: netbird-management
  template:
    metadata:
      labels:
        app: netbird-management
    spec:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      initContainers:
        - name: init-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat <<EOF > /etc/netbird/management.json
              {
                "HttpConfig": {
                  "Address": ":80"
                }
              }
              EOF
          volumeMounts:
            - name: config-writable
              mountPath: /etc/netbird
      containers:
        - name: management
          image: netbirdio/management:0.62.2
          args: ["--port=80", "--log-file=console", "--log-level=info", "--config=/etc/netbird/management.json"]
          ports:
            - containerPort: 80
              name: http
            - containerPort: 33073
              name: grpc
          volumeMounts:
            - name: config-writable
              mountPath: /etc/netbird
            - name: netbird-data
              mountPath: /var/lib/netbird
      volumes:
        - name: config-writable
          emptyDir: {}
        - name: netbird-data
          persistentVolumeClaim:
            claimName: netbird-data
---
apiVersion: v1
kind: Service
metadata:
  name: netbird-management
spec:
  ports:
    - port: 80
      targetPort: 80
      name: http
    - port: 33073
      targetPort: 33073
      name: grpc
  selector:
    app: netbird-management