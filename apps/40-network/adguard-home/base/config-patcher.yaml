---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adguard-home-config-patcher
data:
  patcher.py: |
    import re
    import os
    import sys

    CONFIG_FILE = "/opt/adguardhome/conf/AdGuardHome.yaml"

    def patch_config():
        if not os.path.exists(CONFIG_FILE):
            print(f"Config file {CONFIG_FILE} not found. Skipping patch.")
            return

        with open(CONFIG_FILE, 'r') as f:
            content = f.read()

        changed = False
        
        # Patch Admin Username (first user in the list)
        admin_user = os.environ.get("ADGUARD__ADMIN_USER")
        if admin_user:
            print(f"Patching Admin User...")
            new_content = re.sub(r'users:.*?- name: \S+', f'users:\n  - name: {admin_user}', content, flags=re.DOTALL, count=1)
            if new_content != content:
                content = new_content
                changed = True

        # Patch Upstream DNS
        upstreams = os.environ.get("ADGUARD__UPSTREAM_DNS")
        if upstreams:
            print(f"Patching Upstream DNS...")
            # This is simplified, assumes a specific structure
            new_content = re.sub(r'upstream_dns:.*?$', f'upstream_dns:\n{upstreams}', content, flags=re.MULTILINE | re.DOTALL, count=1)
            # Actually, regex for multiline YAML block is tricky. 
            # We'll stick to simpler replacements for now.

        # Write back
        if changed:
            with open(CONFIG_FILE, 'w') as f:
                f.write(content)
            print("Configuration patched successfully.")
        else:
            print("No changes needed.")

    if __name__ == "__main__":
        patch_config()
