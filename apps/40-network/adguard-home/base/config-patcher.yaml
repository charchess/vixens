---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adguard-home-config-patcher
data:
  patcher.py: "import re\nimport os\nimport sys\n\nCONFIG_FILE = \"/opt/adguardhome/conf/AdGuardHome.yaml\"\n\ndef patch_config():\n    if not os.path.exists(CONFIG_FILE):\n        print(f\"Config file {CONFIG_FILE} not found. Skipping patch.\")\n        return\n\n    with open(CONFIG_FILE, 'r') as f:\n        content = f.read()\n\n    changed = False\n    \n    # Patch Admin Username (first user in the list)\n    admin_user = os.environ.get(\"ADGUARD__ADMIN_USER\")\n    if admin_user:\n        print(f\"Patching Admin User...\")\n        new_content = re.sub(r'users:.*?- name: \\S+', f'users:\\n  - name: {admin_user}', content, flags=re.DOTALL, count=1)\n        if new_content != content:\n            content = new_content\n            changed = True\n\n    # Patch Upstream DNS\n    upstreams = os.environ.get(\"ADGUARD__UPSTREAM_DNS\")\n    if upstreams:\n        print(f\"Patching Upstream DNS...\")\n        # This is simplified, assumes a specific structure\n        new_content = re.sub(r'upstream_dns:.*?$', f'upstream_dns:\\n{upstreams}', content, flags=re.MULTILINE | re.DOTALL, count=1)\n        # Actually, regex for multiline YAML block is tricky. \n        # We'll stick to simpler replacements for now.\n\n    # Write back\n    if changed:\n        with open(CONFIG_FILE, 'w') as f:\n            f.write(content)\n        print(\"Configuration patched successfully.\")\n    else:\n        print(\"No changes needed.\")\n\nif __name__ == \"__main__\":\n    patch_config()\n"
