---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: changedetection
  labels:
    app: changedetection
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: changedetection
  template:
    metadata:
      labels:
        app: changedetection
    spec:
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      initContainers:
        - name: restore-config
          image: rclone/rclone:1.73
          command:
            - sh
            - -c
          args:
            - |
              export RCLONE_CONFIG_S3_TYPE=s3
              export RCLONE_CONFIG_S3_PROVIDER=Other
              export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
              export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
              export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
              rclone copy s3:$LITESTREAM_BUCKET/config /datastore \
                --transfers 4 \
                --exclude "*.log" \
                --exclude "lost+found/**" \
                || true
          envFrom:
            - secretRef:
                name: changedetection-secrets
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: datastore
              mountPath: /datastore
      containers:
        - name: changedetection
          image: ghcr.io/dgtlmoon/changedetection.io:0.53.5
          ports:
            - containerPort: 5000
              name: http
          env:
            - name: BASE_URL
              value: https://changedetection.dev.truxonline.com # Will be patched in overlays
            - name: PLAYWRIGHT_DRIVER_URL
              value: ws://localhost:3000/?stealth=1&--disable-web-security=true
          resources:
            requests:
              cpu: 50m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          volumeMounts:
            - name: datastore
              mountPath: /datastore
        - name: browserless
          image: browserless/chrome:1.61.1-puppeteer-16.2.0
          ports:
            - containerPort: 3000
              name: playwright
          env:
            - name: SCREEN_WIDTH
              value: "1920"
            - name: SCREEN_HEIGHT
              value: "1080"
            - name: SCREEN_DEPTH
              value: "24"
            - name: ENABLE_DEBUGGER
              value: "false"
            - name: PRE_BOOT_CHROME
              value: "true"
            - name: CONNECTION_TIMEOUT
              value: "300000"
            - name: MAX_CONCURRENT_SESSIONS
              value: "10"
            - name: CHROME_REFRESH_TIME
              value: "600000"
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
        - name: config-syncer
          image: rclone/rclone:1.73
          command:
            - sh
            - -c
          args:
            - |
              export RCLONE_CONFIG_S3_TYPE=s3
              export RCLONE_CONFIG_S3_PROVIDER=Other
              export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
              export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
              export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
              sync_s3() {
                rclone sync /datastore s3:$LITESTREAM_BUCKET/config \
                  --exclude "*.log" \
                  --exclude "lost+found/**";
              }
              while true; do
                sync_s3;
                sleep 60;
              done
          envFrom:
            - secretRef:
                name: changedetection-secrets
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: datastore
              mountPath: /datastore
      volumes:
        - name: datastore
          persistentVolumeClaim:
            claimName: changedetection-datastore-pvc
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
