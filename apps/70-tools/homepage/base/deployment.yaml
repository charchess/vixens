apiVersion: apps/v1
kind: Deployment
metadata:
  name: homepage
  labels:
    app.kubernetes.io/name: homepage
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: homepage
  template:
    metadata:
      labels:
        app.kubernetes.io/name: homepage
    spec:
      tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
      
      # Init container to copy initial config from the read-only ConfigMap
      # to the writable PVC, if the PVC is empty.
      initContainers:
      - name: copy-initial-config
        image: busybox:1.36
        # If the /config dir is empty, copy the default config files into it.
        # The -L flag for 'cp' follows symbolic links.
        command: ['sh', '-c', 'if [ -z "$(ls -A /config)" ]; then cp -L /initial-config/* /config/; fi']
        volumeMounts:
        - name: initial-config-vol
          mountPath: /initial-config
        - name: config-vol
          mountPath: /config

      # Main application container
      containers:
      - name: homepage
        image: ghcr.io/gethomepage/homepage:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
          name: http
        volumeMounts:
        # Mount the writable PVC, which now contains the config files.
        - name: config-vol
          mountPath: /app/config

      # Volume definitions
      volumes:
      # The read-only ConfigMap containing the default configuration
      - name: initial-config-vol
        configMap:
          name: homepage-config
      # The writable PersistentVolumeClaim for the config
      - name: config-vol
        persistentVolumeClaim:
          claimName: homepage-config