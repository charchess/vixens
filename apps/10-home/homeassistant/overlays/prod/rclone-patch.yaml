---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homeassistant
spec:
  template:
    spec:
      initContainers:
        - name: restore-config
          args:
            - |
              export RCLONE_CONFIG_S3_TYPE=s3
              export RCLONE_CONFIG_S3_PROVIDER=Other
              export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
              export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
              export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
              rclone copy s3:$LITESTREAM_BUCKET/homeassistant/config /config --transfers 4  --exclude "*.db*"  --exclude "*.log"  --exclude "tts/**"  --exclude "tmp_backups/**"  --exclude ".home-assistant_v2.db-litestream/**" 2>/dev/null || true
      containers:
        - name: config-syncer
          args:
            - |
              apk add --no-cache rclone inotify-tools
              export RCLONE_CONFIG_S3_TYPE=s3
              export RCLONE_CONFIG_S3_PROVIDER=Other
              export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
              export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
              export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
              sync_s3() { rclone sync /config s3:$LITESTREAM_BUCKET/homeassistant/config  --exclude "*.db*"  --exclude "*.log"  --exclude "tts/**"  --exclude "tmp_backups/**"  --exclude ".home-assistant_v2.db-litestream/**"; }
              sync_s3
              while true; do inotifywait -r -e modify,create,delete,move /config --exclude ".*\.db.*"; sync_s3; sleep 10; done
