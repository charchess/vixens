---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-create-users
  namespace: databases
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: postgresql-create-users
    spec:
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      restartPolicy: OnFailure
      serviceAccountName: default
      containers:
        - name: create-users
          image: postgres:17
          env:
            # PostgreSQL admin credentials
            - name: PGHOST
              value: postgresql-shared-rw
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: postgresql-admin-credentials
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-admin-credentials
                  key: password
            # Application credentials from Infisical
            - name: LINKWARDEN_USER
              valueFrom:
                secretKeyRef:
                  name: linkwarden-postgresql-credentials
                  key: username
            - name: LINKWARDEN_PASS
              valueFrom:
                secretKeyRef:
                  name: linkwarden-postgresql-credentials
                  key: password
            - name: DOCSPELL_USER
              valueFrom:
                secretKeyRef:
                  name: docspell-postgresql-credentials
                  key: username
            - name: DOCSPELL_PASS
              valueFrom:
                secretKeyRef:
                  name: docspell-postgresql-credentials
                  key: password
            - name: NETBOX_USER
              valueFrom:
                secretKeyRef:
                  name: netbox-postgresql-credentials
                  key: username
            - name: NETBOX_PASS
              valueFrom:
                secretKeyRef:
                  name: netbox-postgresql-credentials
                  key: password
            - name: AUTHENTIK_USER
              valueFrom:
                secretKeyRef:
                  name: authentik-postgresql-credentials
                  key: username
            - name: AUTHENTIK_PASS
              valueFrom:
                secretKeyRef:
                  name: authentik-postgresql-credentials
                  key: password
            - name: SCANOPY_USER
              valueFrom:
                secretKeyRef:
                  name: scanopy-postgresql-credentials
                  key: username
            - name: SCANOPY_PASS
              valueFrom:
                secretKeyRef:
                  name: scanopy-postgresql-credentials
                  key: password
            - name: VAULTWARDEN_USER
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-postgresql-credentials
                  key: username
            - name: VAULTWARDEN_PASS
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-postgresql-credentials
                  key: password
            - name: NETBIRD_USER
              valueFrom:
                secretKeyRef:
                  name: netbird-postgresql-credentials
                  key: username
            - name: NETBIRD_PASS
              valueFrom:
                secretKeyRef:
                  name: netbird-postgresql-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - "set -e\n\necho \"=== PostgreSQL User Creation Job ===\"\necho \"Target: $PGHOST:$PGPORT\"\necho \"\"\n\n# Function to create user if not exists\ncreate_user_if_not_exists() {\n  local username=$1\n  local password=$2\n\n  if [ -z \"$username\" ] || [ -z \"$password\" ]; then\n    echo \"  âš ï¸  Skipping user creation: username or password missing.\"\n    return\n  fi\n\n  echo \"Checking user: $username\"\n\n  # Check if user exists\n  USER_EXISTS=$(psql -tAc \"SELECT 1 FROM pg_roles WHERE rolname='$username'\" 2>/dev/null || echo \"0\")\n\n  if [ \"$USER_EXISTS\" = \"1\" ]; then\n    echo \"  âœ… User '$username' already exists\"\n    # Update password in case it changed\n    psql -c \"ALTER USER $username WITH PASSWORD '$password';\" > /dev/null\n    echo \"  ðŸ”‘ Password updated\"\n  else\n    echo \"  âž• Creating user '$username'\"\n    psql -c \"CREATE USER $username WITH PASSWORD '$password';\" > /dev/null\n    echo \"  âœ… User '$username' created\"\n  fi\n  echo \"\"\n}\n\n# Wait for PostgreSQL to be ready\necho \"Waiting for PostgreSQL...\"\nuntil psql -c '\\q' 2>/dev/null; do\n  echo \"  PostgreSQL not ready, waiting...\"\n  sleep 2\ndone\necho \"âœ… PostgreSQL is ready\"\necho \"\"\n\n# Create all application users\ncreate_user_if_not_exists \"$LINKWARDEN_USER\" \"$LINKWARDEN_PASS\"\ncreate_user_if_not_exists \"$DOCSPELL_USER\" \"$DOCSPELL_PASS\"\ncreate_user_if_not_exists \"$NETBOX_USER\" \"$NETBOX_PASS\"\ncreate_user_if_not_exists \"$AUTHENTIK_USER\" \"$AUTHENTIK_PASS\"\ncreate_user_if_not_exists \"$SCANOPY_USER\" \"$SCANOPY_PASS\"\ncreate_user_if_not_exists \"$VAULTWARDEN_USER\" \"$VAULTWARDEN_PASS\"\ncreate_user_if_not_exists \"$NETBIRD_USER\" \"$NETBIRD_PASS\"\n# create_user_if_not_exists \"$NOCODB_USER\" \"$NOCODB_PASS\"\n\necho \"=== User creation completed ===\"\n\n# List all users\necho \"\"\necho \"Current PostgreSQL users:\"\npsql -c \"\\du\" | grep -E \"(linkwarden|docspell|netbox|authentik|nocodb|Role name)\"\n\nexit 0\n"