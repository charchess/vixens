apiVersion: v1
kind: ConfigMap
metadata:
  name: mylar-config-patcher
data:
  patcher.py: |
    import re
    import os
    import sys

    CONFIG_FILE = "/config/mylar/config.ini"

    def patch_config():
        if not os.path.exists(CONFIG_FILE):
            print(f"Config file {CONFIG_FILE} not found. Skipping patch.")
            return

        with open(CONFIG_FILE, 'r') as f:
            content = f.read()

        changed = False
        # Patch API Key
        api_key = os.environ.get("API_KEY")
        if api_key:
            print(f"Patching API Key...")
            new_content = re.sub(r'^api_key\s*=\s*.*$', f'api_key = {api_key}', content, flags=re.MULTILINE)
            if new_content != content:
                content = new_content
                changed = True

        # Write back if changed
        if changed:
            with open(CONFIG_FILE, 'w') as f:
                f.write(content)
            print("Configuration patched successfully.")
        else:
            print("No changes needed.")

    if __name__ == "__main__":
        patch_config()
