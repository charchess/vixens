---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sonarr-config-patcher
data:
  patcher.py: "import xml.etree.ElementTree as ET\nimport os\nimport sqlite3\nimport json\n\nCONFIG_FILE = \"/config/config.xml\"\nDB_FILE = \"/config/sonarr.db\"\n\ndef patch_config_xml():\n    if not os.path.exists(CONFIG_FILE):\n        return\n    try:\n        tree = ET.parse(CONFIG_FILE)\n        root = tree.getroot()\n        changed = False\n        api_key = os.environ.get(\"API_KEY\")\n        if api_key:\n            elem = root.find(\"ApiKey\")\n            if elem is None: elem = ET.SubElement(root, \"ApiKey\")\n            if elem.text != api_key:\n                print(f\"Patching local API Key in config.xml...\")\n                elem.text = api_key\n                changed = True\n        if changed:\n            tree.write(CONFIG_FILE, encoding=\"utf-8\", xml_declaration=True)\n            print(\"config.xml patched.\")\n        else:\n            print(\"No changes needed in config.xml.\")\n    except Exception as e:\n        print(f\"Error patching config.xml: {e}\")\n\ndef patch_db():\n    if not os.path.exists(DB_FILE):\n        print(f\"DB file {DB_FILE} not found. Skipping DB patch.\")\n        return\n    try:\n        conn = sqlite3.connect(DB_FILE)\n        cur = conn.cursor()\n        \n        # 1. Patch Sabnzbd API Key in DownloadClients\n        sab_key = os.environ.get(\"SABNZBD__API_KEY\")\n        if sab_key:\n            clients = cur.execute(\"SELECT id, settings FROM DownloadClients WHERE implementation = 'Sabnzbd'\").fetchall()\n            for row_id, settings_json in clients:\n                settings = json.loads(settings_json)\n                if settings.get(\"apiKey\") != sab_key:\n                    settings[\"apiKey\"] = sab_key\n                    cur.execute(\"UPDATE DownloadClients SET settings = ? WHERE id = ?\", (json.dumps(settings), row_id))\n                    print(f\"Updated Sabnzbd API key in DB (client id {row_id})\")\n\n        # 2. Patch Prowlarr API Key in Indexers (Torznab/Newznab)\n        prowl_key = os.environ.get(\"PROWLARR__API_KEY\")\n        if prowl_key:\n            indexers = cur.execute(\"SELECT id, settings FROM Indexers\").fetchall()\n            for row_id, settings_json in indexers:\n                try:\n                    settings = json.loads(settings_json)\n                    # Check if it looks like a Prowlarr/Torznab indexer\n                    if \"apiKey\" in settings and (\"prowlarr\" in settings.get(\"baseUrls\", [\"\"])[0] or \"prowlarr\" in settings.get(\"baseUrl\", \"\")):\n                        if settings[\"apiKey\"] != prowl_key:\n                            settings[\"apiKey\"] = prowl_key\n                            cur.execute(\"UPDATE Indexers SET settings = ? WHERE id = ?\", (json.dumps(settings), row_id))\n                            print(f\"Updated Prowlarr API key in DB (indexer id {row_id})\")\n                except: continue\n\n        conn.commit()\n        conn.close()\n    except Exception as e:\n        print(f\"Error patching DB: {e}\")\n\nif __name__ == \"__main__\":\n    patch_config_xml()\n    patch_db()\n"
