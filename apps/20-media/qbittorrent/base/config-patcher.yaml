---

apiVersion: v1
kind: ConfigMap
metadata:
  name: qbittorrent-config-patcher
  namespace: downloads
data:
  patcher.py: "import os\nimport re\nimport hashlib\nimport base64\n\nCONF_PATH = \"/config/qBittorrent/config/qBittorrent.conf\"\n\ndef patch():\n    if not os.path.exists(CONF_PATH):\n        print(\"Config not found. Creating a minimal one.\")\n        os.makedirs(os.path.dirname(CONF_PATH), exist_ok=True)\n        with open(CONF_PATH, 'w') as f:\n            f.write(\"[Preferences]\\n\")\n\n    username = os.environ.get(\"WEBUI_USERNAME\")\n    password = os.environ.get(\"WEBUI_PASSWORD\")\n    \n    if not username or not password:\n        print(\"Missing env vars.\")\n        return\n\n    with open(CONF_PATH, 'r') as f:\n        lines = f.readlines()\n\n    new_lines = []\n    # Fallback to MD5 for easier injection\n    pwd_hash_md5 = hashlib.md5(password.encode('utf-8')).hexdigest()\n    \n    key_user = \"WebUI\" + chr(92) + \"Username=\"\n    key_pass_pbkdf2 = \"WebUI\" + chr(92) + \"Password_PBKDF2=\"\n    key_pass_md5 = \"WebUI\" + chr(92) + \"Password_md5=\"\n    \n    found_user = False\n    found_md5 = False\n    \n    for line in lines:\n        if line.startswith(key_user):\n            new_lines.append(f\"{key_user}{username}\\n\")\n            found_user = True\n        elif line.startswith(key_pass_pbkdf2):\n            continue # Remove PBKDF2 to force MD5 usage\n        elif line.startswith(key_pass_md5):\n            new_lines.append(f\"{key_pass_md5}{pwd_hash_md5}\\n\")\n            found_md5 = True\n        else:\n            new_lines.append(line)\n\n    if not found_user:\n        new_lines.insert(1, f\"{key_user}{username}\\n\")\n    if not found_md5:\n        new_lines.insert(1, f\"{key_pass_md5}{pwd_hash_md5}\\n\")\n\n    with open(CONF_PATH, 'w') as f:\n        f.writelines(new_lines)\n    \n    os.chown(CONF_PATH, 1000, 1000)\n    print(f\"Successfully patched qBittorrent with MD5 for user {username}\")\n\nif __name__ == \"__main__\":\n    patch()"
