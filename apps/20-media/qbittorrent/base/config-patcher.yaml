--- 
apiVersion: v1
kind: ConfigMap
metadata:
  name: qbittorrent-config-patcher
  namespace: downloads
data:
  patcher.py: |
    import os
    import re
    import hashlib
    import base64

    CONF_PATH = "/config/qBittorrent/config/qBittorrent.conf"

    def generate_hash(password):
        salt = os.urandom(16)
        key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt, 100000)
        salt_b64 = base64.b64encode(salt).decode('utf-8')
        key_b64 = base64.b64encode(key).decode('utf-8')
        return f"@ByteArray({salt_b64}:{key_b64})"

    def patch():
        if not os.path.exists(CONF_PATH):
            print("Config not found. Creating a minimal one.")
            os.makedirs(os.path.dirname(CONF_PATH), exist_ok=True)
            with open(CONF_PATH, 'w') as f:
                f.write("[Preferences]\n")

        username = os.environ.get("WEBUI_USERNAME")
        password = os.environ.get("WEBUI_PASSWORD")
        
        if not username or not password:
            print("Missing env vars.")
            return

        with open(CONF_PATH, 'r') as f:
            lines = f.readlines()

        new_lines = []
        pwd_hash = generate_hash(password)
        
        found_user = False
        found_pass = False
        
        for line in lines:
            if line.startswith("WebUI\Username="):
                new_lines.append(f"WebUI\Username={username}\n")
                found_user = True
            elif line.startswith("WebUI\Password_PBKDF2="):
                new_lines.append(f"WebUI\Password_PBKDF2={pwd_hash}\n")
                found_pass = True
            else:
                new_lines.append(line)

        if not found_user:
            new_lines.insert(1, f"WebUI\Username={username}\n")
        if not found_pass:
            new_lines.insert(1, f"WebUI\Password_PBKDF2={pwd_hash}\n")

        with open(CONF_PATH, 'w') as f:
            f.writelines(new_lines)
        print(f"Successfully patched qBittorrent for user {username}")

    if __name__ == "__main__":
        patch()