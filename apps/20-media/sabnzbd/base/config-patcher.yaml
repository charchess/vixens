apiVersion: v1
kind: ConfigMap
metadata:
  name: sabnzbd-config-patcher
data:
  patcher.py: |
    import configparser
    import os
    import sys

    CONFIG_FILE = "/config/sabnzbd.ini"

    def patch_config():
        if not os.path.exists(CONFIG_FILE):
            print(f"Config file {CONFIG_FILE} not found. Skipping patch.")
            return

        config = configparser.ConfigParser()
        config.read(CONFIG_FILE)

        # Patch API Key
        api_key = os.environ.get("SABNZBD__API_KEY")
        if api_key:
            if not config.has_section("misc"):
                config.add_section("misc")
            print(f"Patching API Key...")
            config.set("misc", "api_key", api_key)
            config.set("misc", "nzb_key", api_key)

        # Patch Whitelist
        whitelist = os.environ.get("HOST_WHITELIST_ENTRIES")
        if whitelist:
            if not config.has_section("misc"):
                config.add_section("misc")
            print(f"Patching Whitelist: {whitelist}")
            config.set("misc", "host_whitelist", whitelist)

        # Write back
        with open(CONFIG_FILE, 'w') as configfile:
            config.write(configfile)
        print("Configuration patched successfully.")

    if __name__ == "__main__":
        patch_config()
