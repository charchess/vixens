---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sabnzbd-config-patcher
data:
  patcher.py: "import configparser\nimport os\nimport sys\n\nCONFIG_FILE = \"/config/sabnzbd.ini\"\n\nimport re\n\ndef patch_config():\n    if not os.path.exists(CONFIG_FILE):\n        print(f\"Config file {CONFIG_FILE} not found. Skipping patch.\")\n        return\n\n    with open(CONFIG_FILE, 'r') as f:\n        lines = f.readlines()\n\n    new_lines = []\n    current_section = None\n    current_subsection = None\n    \n    api_key = os.environ.get(\"SABNZBD__API_KEY\")\n    whitelist = os.environ.get(\"HOST_WHITELIST_ENTRIES\")\n    u_host = os.environ.get(\"USENET_HOST\")\n    u_user = os.environ.get(\"USENET_USER\")\n    u_pass = os.environ.get(\"USENET_PASS\")\n    \n    # New admin credentials (optional)\n    admin_user = os.environ.get(\"SABNZBD__ADMIN_USER\", \"\")\n    admin_pass = os.environ.get(\"SABNZBD__ADMIN_PASS\", \"\")\n\n    misc_patched = {k: False for k in [\"api_key\", \"nzb_key\", \"host_whitelist\", \"wizard_completed\", \"username\", \"password\"]}\n\n    for line in lines:\n        stripped = line.strip()\n        \n        # Detect sections\n        if stripped.startswith(\"[[\") and stripped.endswith(\"]]\"):\n            current_subsection = stripped[2:-2]\n        elif stripped.startswith(\"[\") and stripped.endswith(\"]\"):\n            current_section = stripped[1:-1]\n            current_subsection = None\n        \n        patched_line = line\n\n        # Logic for [misc]\n        if current_section == \"misc\" and not current_subsection:\n            if api_key:\n                if stripped.startswith(\"api_key =\"):\n                    patched_line = f\"api_key = {api_key}\\n\"\n                    misc_patched[\"api_key\"] = True\n                elif stripped.startswith(\"nzb_key =\"):\n                    patched_line = f\"nzb_key = {api_key}\\n\"\n                    misc_patched[\"nzb_key\"] = True\n            \n            if whitelist and stripped.startswith(\"host_whitelist =\"):\n                patched_line = f\"host_whitelist = {whitelist}\\n\"\n                misc_patched[\"host_whitelist\"] = True\n            \n            if stripped.startswith(\"wizard_completed =\"):\n                patched_line = \"wizard_completed = 1\\n\"\n                misc_patched[\"wizard_completed\"] = True\n            \n            # Admin UI credentials\n            if admin_user and stripped.startswith(\"username =\"):\n                patched_line = f\"username = {admin_user}\\n\"\n                misc_patched[\"username\"] = True\n            if admin_pass and stripped.startswith(\"password =\"):\n                patched_line = f\"password = {admin_pass}\\n\"\n                misc_patched[\"password\"] = True\n\n        # Logic for [servers]\n        if current_section == \"servers\" and current_subsection:\n            # If we are in a subsection of servers, we assume it's a usenet server\n            if u_user and stripped.startswith(\"username =\"):\n                print(f\"Patching Usenet Username in section [[{current_subsection}]]\")\n                patched_line = f\"username = {u_user}\\n\"\n            if u_pass and stripped.startswith(\"password =\"):\n                print(f\"Patching Usenet Password in section [[{current_subsection}]]\")\n                patched_line = f\"password = {u_pass}\\n\"\n            if u_host and stripped.startswith(\"host =\"):\n                print(f\"Patching Usenet Host in section [[{current_subsection}]]\")\n                patched_line = f\"host = {u_host}\\n\"\n\n        new_lines.append(patched_line)\n\n    # Post-process: add missing fields in [misc]\n    if not misc_patched[\"wizard_completed\"]:\n        for i, l in enumerate(new_lines):\n            if l.strip() == \"[misc]\":\n                print(\"Adding wizard_completed = 1\")\n                new_lines.insert(i+1, \"wizard_completed = 1\\n\")\n                break\n\n    # Write back\n    with open(CONFIG_FILE, 'w') as f:\n        f.writelines(new_lines)\n    print(\"Configuration patched with section awareness.\")\n\nif __name__ == \"__main__\":\n    patch_config()\n"
