apiVersion: v1
kind: ConfigMap
metadata:
  name: sabnzbd-config-patcher
data:
  patcher.py: |
    import configparser
    import os
    import sys

    CONFIG_FILE = "/config/sabnzbd.ini"

    import re

    def patch_config():
        if not os.path.exists(CONFIG_FILE):
            print(f"Config file {CONFIG_FILE} not found. Skipping patch.")
            return

        with open(CONFIG_FILE, 'r') as f:
            content = f.read()

        # Patch API Key
        api_key = os.environ.get("SABNZBD__API_KEY")
        if api_key:
            print(f"Patching API Key...")
            content = re.sub(r'^api_key\s*=\s*.*$', f'api_key = {api_key}', content, flags=re.MULTILINE)
            content = re.sub(r'^nzb_key\s*=\s*.*$', f'nzb_key = {api_key}', content, flags=re.MULTILINE)

        # Patch Whitelist
        whitelist = os.environ.get("HOST_WHITELIST_ENTRIES")
        if whitelist:
            print(f"Patching Whitelist: {whitelist}")
            content = re.sub(r'^host_whitelist\s*=\s*.*$', f'host_whitelist = {whitelist}', content, flags=re.MULTILINE)

        # Patch Usenet Config (Server 0)
        u_host = os.environ.get("USENET_HOST")
        u_user = os.environ.get("USENET_USER")
        u_pass = os.environ.get("USENET_PASS")
        
        if u_host:
            print(f"Patching Usenet Host: {u_host}")
            # Note: This simple patch assumes the first server entry in the ini
            content = re.sub(r'^host\s*=\s*.*$', f'host = {u_host}', content, flags=re.MULTILINE)
        if u_user:
            print(f"Patching Usenet User...")
            content = re.sub(r'^username\s*=\s*.*$', f'username = {u_user}', content, flags=re.MULTILINE)
        if u_pass:
            print(f"Patching Usenet Password...")
            content = re.sub(r'^password\s*=\s*.*$', f'password = {u_pass}', content, flags=re.MULTILINE)

        # Write back
        with open(CONFIG_FILE, 'w') as f:
            f.write(content)
        print("Configuration patched successfully.")

    if __name__ == "__main__":
        patch_config()
