# Kustomize Component: Elite Syncer (Config-Syncer)
#
# Adds an rclone-based sidecar to sync /config to S3 (MinIO).
# Uses inotify to detect changes and sync in real-time.
#
# Requirements:
# - A Secret named "litestream-shared-secrets" (from Infisical)
# - A volume named "config" mounted at /config
#
# Usage:
#   components:
#     - ../../../../_shared/components/elite-syncer

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
  - target:
      kind: Deployment
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: all-deployments
      spec:
        template:
          spec:
            initContainers:
              - name: restore-config
                image: rclone/rclone:1.73
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                command:
                  - sh
                  - -c
                args:
                  - |
                    export RCLONE_CONFIG_S3_TYPE=s3
                    export RCLONE_CONFIG_S3_PROVIDER=Other
                    export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
                    export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
                    export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
                    # Sync FROM S3 TO /config on startup
                    rclone copy s3:$LITESTREAM_BUCKET/config /config \
                      --transfers 4 \
                      --exclude "*.log" \
                      --exclude ".*-litestream" \
                      --exclude ".*-litestream/**" \
                      2>/dev/null || true
                envFrom:
                  - secretRef:
                      name: litestream-shared-secrets
                volumeMounts:
                  - name: config
                    mountPath: /config
            containers:
              - name: config-syncer
                image: rclone/rclone:1.73
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                command:
                  - sh
                  - -c
                args:
                  - |
                    export RCLONE_CONFIG_S3_TYPE=s3
                    export RCLONE_CONFIG_S3_PROVIDER=Other
                    export RCLONE_CONFIG_S3_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID
                    export RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY
                    export RCLONE_CONFIG_S3_ENDPOINT=$LITESTREAM_ENDPOINT
                    sync_s3() { 
                      rclone sync /config s3:$LITESTREAM_BUCKET/config \
                        --exclude "*.log" \
                        --exclude ".*\.db.*" \
                        --exclude ".*-litestream" \
                        --exclude ".*-litestream/**"; 
                    }
                    while true; do 
                      sync_s3; 
                      sleep 60; 
                    done
                envFrom:
                  - secretRef:
                      name: litestream-shared-secrets
                volumeMounts:
                  - name: config
                    mountPath: /config