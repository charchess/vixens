---
# Kustomize Component: Elite Litestream
#
# Adds Litestream sidecar and restore initContainer to a Deployment.
#
# Requirements:
# - A ConfigMap named "${APP_NAME}-litestream-config" with litestream.yml
# - A Secret named "litestream-shared-secrets" (from Infisical)
# - A volume named "config" (or equivalent) where the DB resides.
#
# Usage:
#   components:
#     - ../../../../_shared/components/elite-litestream
#   patches:
#     - target:
#         kind: Deployment
#         name: my-app
#       patch: |-
#         - op: replace
#           path: /spec/template/spec/initContainers/0/args/5
#           value: /config/my-db.sqlite3

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
  - target:
      kind: Deployment
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: all-deployments
      spec:
        template:
          spec:
            initContainers:
              - name: restore-db
                image: litestream/litestream:0.5.8
                args:
                  - restore
                  - -config
                  - /etc/litestream.yml
                  - -if-db-not-exists
                  - -if-replica-exists
                  - /config/db.sqlite3 # Default path, override via patch
                envFrom:
                  - secretRef:
                      name: litestream-shared-secrets
                volumeMounts:
                  - name: config
                    mountPath: /config
                  - name: litestream-config
                    mountPath: /etc/litestream.yml
                    subPath: litestream.yml
            containers:
              - name: litestream
                image: litestream/litestream:0.5.8
                args:
                  - replicate
                  - -config
                  - /etc/litestream.yml
                ports:
                  - containerPort: 9090
                    name: metrics
                envFrom:
                  - secretRef:
                      name: litestream-shared-secrets
                volumeMounts:
                  - name: config
                    mountPath: /config
                  - name: litestream-config
                    mountPath: /etc/litestream.yml
                    subPath: litestream.yml
            volumes:
              - name: litestream-config
                configMap:
                  name: litestream-config # Expected to be provided or renamed
