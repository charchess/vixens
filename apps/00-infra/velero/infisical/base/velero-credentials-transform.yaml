---
# Transform InfisicalSecret output to Velero-compatible format
# This CronJob syncs LITESTREAM_* keys to AWS_* keys in the 'velero' secret
apiVersion: batch/v1
kind: CronJob
metadata:
  name: velero-credentials-sync
  namespace: velero
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: velero-credentials-sync
          restartPolicy: OnFailure
          priorityClassName: vixens-low
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: sync
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  # Read source secret
                  ACCESS_KEY=$(kubectl get secret velero-s3-credentials -n velero -o jsonpath='{.data.LITESTREAM_ACCESS_KEY_ID}')
                  SECRET_KEY=$(kubectl get secret velero-s3-credentials -n velero -o jsonpath='{.data.LITESTREAM_SECRET_ACCESS_KEY}')

                  # Create/update velero secret with AWS_ keys
                  kubectl create secret generic velero -n velero \
                    --from-literal=AWS_ACCESS_KEY_ID="$(echo $ACCESS_KEY | base64 -d)" \
                    --from-literal=AWS_SECRET_ACCESS_KEY="$(echo $SECRET_KEY | base64 -d)" \
                    --dry-run=client -o yaml | kubectl apply -f -

                  echo "Velero credentials synced successfully"
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 50m
                  memory: 64Mi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero-credentials-sync
  namespace: velero
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: velero-credentials-sync
  namespace: velero
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: velero-credentials-sync
  namespace: velero
subjects:
  - kind: ServiceAccount
    name: velero-credentials-sync
    namespace: velero
roleRef:
  kind: Role
  name: velero-credentials-sync
  apiGroup: rbac.authorization.k8s.io
