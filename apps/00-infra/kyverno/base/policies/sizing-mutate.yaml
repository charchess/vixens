---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sizing-mutate
  annotations:
    policies.kyverno.io/title: Granular Sizing Mutation
    policies.kyverno.io/category: Resource Management
    policies.kyverno.io/description: >-
      Declarative resource management using per-container labels.
spec:
  validationFailureAction: Audit
  background: false
  rules:
    # Rule 1: Per-container Sizing (Explicit container labels)
    - name: granular-container-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              names:
                - trivy-server # Exclude trivy-server from sizing mutation
              namespaces:
                - security
      mutate:
        foreach:
          - list: "request.object.spec.containers || '[]'" # Safety for empty containers list
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'large' && '1000m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'medium' && '200m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '50m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'micro' && '10m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'large') && '1000m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'medium') && '200m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'small') && '50m' || '10m' }}"
                        memory: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'large' && '4Gi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'medium' && '1Gi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '512Mi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'micro' && '128Mi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'large') && '4Gi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'medium') && '1Gi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'small') && '512Mi' || '128Mi' }}"
                      limits:
                        cpu: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'large' && '2000m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'medium' && '1000m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '500m' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'micro' && '100m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'large') && '2000m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'medium') && '1000m' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'small') && '500m' || '100m' }}"
                        memory: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'large' && '4Gi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'medium' && '1Gi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '512Mi' || request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'micro' && '128Mi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'large') && '4Gi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'medium') && '1Gi' || (element.name == request.object.metadata.labels.app && request.object.metadata.labels.\"vixens.io/sizing\" == 'small') && '512Mi' || '128Mi' }}"

    # Rule 2: Init Containers Sizing (Granular)
    - name: granular-init-container-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              names:
                - trivy-server # Exclude trivy-server from sizing mutation
              namespaces:
                - security
      mutate:
        foreach:
          - list: "request.object.spec.initContainers || '[]'" # Safety for missing initContainers
            patchStrategicMerge:
              spec:
                initContainers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '50m' || '10m' }}"
                        memory: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '256Mi' || '64Mi' }}"
                      limits:
                        cpu: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '500m' || '100m' }}"
                        memory: "{{ request.object.metadata.labels.\"vixens.io/sizing.{{element.name}}\" == 'small' && '512Mi' || '128Mi' }}"
