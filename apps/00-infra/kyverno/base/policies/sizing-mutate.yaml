---
# Kyverno Policy: Sizing Mutation
#
# This policy automatically applies resource sizing based on the
# vixens.io/sizing label. If no label is present, defaults to 'micro'.
#
# PHASE: Enforce (mutation active)
# STATUS: Active
#
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sizing-mutate
  annotations:
    policies.kyverno.io/title: Sizing Mutation
    policies.kyverno.io/category: Resource Management
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Automatically applies resource requests/limits based on vixens.io/sizing label.
      This version uses foreach loops to prevent index conflicts and panics.
spec:
  validationFailureAction: Audit
  background: false
  rules:
    # Rule 1: Default to micro if no sizing label (Main container only)
    - name: default-micro
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - kube-public
                - kube-node-lease
          - resources:
              selector:
                matchLabels:
                  vixens.io/sizing: "?*"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: NotIn
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "10m"
                        memory: "64Mi"
                      limits:
                        cpu: "100m"
                        memory: "128Mi"

    # Rule 2: Small sizing
    - name: small-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "small"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: NotIn
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "50m"
                        memory: "256Mi"
                      limits:
                        cpu: "500m"
                        memory: "512Mi"

    # Rule 3: Medium sizing
    - name: medium-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "medium"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: NotIn
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "200m"
                        memory: "512Mi"
                      limits:
                        cpu: "1000m"
                        memory: "1Gi"

    # Rule 4: Large sizing
    - name: large-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "large"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: NotIn
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "1000m"
                        memory: "2Gi"
                      limits:
                        cpu: "2000m"
                        memory: "4Gi"

    # Rule 5: XLarge sizing
    - name: xlarge-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "xlarge"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: NotIn
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "2000m"
                        memory: "4Gi"
                      limits:
                        cpu: "4000m"
                        memory: "8Gi"

    # Rule 6: Sidecars (Always Micro)
    - name: sidecar-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            preconditions:
              all:
              - key: "{{ element.name }}"
                operator: In
                value: ["litestream", "config-syncer", "node-agent", "cloudnative-pg"]
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "10m"
                        memory: "64Mi"
                      limits:
                        cpu: "100m"
                        memory: "128Mi"

    # Rule 7: Init Containers (Always Micro)
    - name: init-container-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
      mutate:
        foreach:
          - list: "request.object.spec.initContainers"
            patchStrategicMerge:
              spec:
                initContainers:
                  - (name): "{{ element.name }}"
                    resources:
                      requests:
                        cpu: "10m"
                        memory: "64Mi"
                      limits:
                        cpu: "100m"
                        memory: "128Mi"
