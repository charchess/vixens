---
# Kyverno Policy: Sizing Mutation
#
# This policy automatically applies resource sizing based on the
# vixens.io/sizing label. If no label is present, defaults to 'micro'.
#
# PHASE: Enforce (mutation active)
# STATUS: Disabled by default - enable when ready for migration
#
# To enable: kubectl patch clusterpolicy sizing-mutate -p '{"spec":{"validationFailureAction":"Enforce"}}'

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sizing-mutate
  annotations:
    policies.kyverno.io/title: Sizing Mutation
    policies.kyverno.io/category: Resource Management
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Automatically applies resource requests/limits based on vixens.io/sizing label.
      Supported values: micro, small, medium, large, xlarge (Burstable),
      and G-small, G-medium, G-large, G-xl (Guaranteed QoS).
      Defaults to 'micro' if no label is present.
      
      Burstable (requests < limits): micro, small, medium, large, xlarge
      Guaranteed (requests = limits): G-small, G-medium, G-large, G-xl
      
      Migration guide:
      1. Run sizing-audit policy to identify apps
      2. Add vixens.io/sizing labels to critical apps
      3. Test sizing-mutate in dev cluster
      4. Enable sizing-mutate in prod when ready
spec:
  validationFailureAction: Audit  # â† Disabled by default
  background: false
  rules:
    # Rule 1: Default to micro if no sizing label
    - name: default-micro
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - kube-public
                - kube-node-lease
          - resources:
              selector:
                matchLabels:
                  vixens.io/sizing: "?*"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "10m"
                    memory: "64Mi"
                  limits:
                    cpu: "100m"
                    memory: "128Mi"

    # Rule 2: Small sizing
    - name: small-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "small"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "50m"
                    memory: "256Mi"
                  limits:
                    cpu: "500m"
                    memory: "512Mi"

    # Rule 3: Medium sizing
    - name: medium-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "medium"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "200m"
                    memory: "512Mi"
                  limits:
                    cpu: "1000m"
                    memory: "1Gi"

    # Rule 4: Large sizing
    - name: large-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "large"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "1000m"
                    memory: "2Gi"
                  limits:
                    cpu: "2000m"
                    memory: "4Gi"

    # Rule 5: XLarge sizing
    - name: xlarge-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "xlarge"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "2000m"
                    memory: "4Gi"
                  limits:
                    cpu: "4000m"
                    memory: "8Gi"

    # Rule 6: Micro sizing (explicit label)
    - name: micro-sizing
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "micro"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "10m"
                    memory: "64Mi"
                  limits:
                    cpu: "100m"
                    memory: "128Mi"

    # Rule 7: Guaranteed Small (G-small) - 50m/128Mi (requests=limits)
    - name: guaranteed-small
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-small"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "50m"
                    memory: "128Mi"
                  limits:
                    cpu: "50m"
                    memory: "128Mi"

    # Rule 8: Guaranteed Medium (G-medium) - 200m/512Mi (requests=limits)
    - name: guaranteed-medium
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-medium"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "200m"
                    memory: "512Mi"
                  limits:
                    cpu: "200m"
                    memory: "512Mi"

    # Rule 9: Guaranteed Large (G-large) - 1000m/2Gi (requests=limits)
    - name: guaranteed-large
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-large"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "1000m"
                    memory: "2Gi"
                  limits:
                    cpu: "1000m"
                    memory: "2Gi"

    # Rule 10: Guaranteed XLarge (G-xl) - 2000m/4Gi (requests=limits)
    - name: guaranteed-xlarge
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-xl"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "2000m"
                    memory: "4Gi"
                  limits:
                    cpu: "2000m"
                    memory: "4Gi"