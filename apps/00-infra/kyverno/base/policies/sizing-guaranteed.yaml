---
# Kyverno Policy: Guaranteed QoS Sizing
#
# This policy provides Guaranteed QoS resource sizing for Orichalcum tier apps.
# Guaranteed QoS requires: requests.cpu == limits.cpu AND requests.memory == limits.memory
#
# WARNING: Guaranteed QoS consumes more cluster resources (no overcommit).
# Use sparingly - only for critical apps that need Orichalcum tier.
#
# Usage:
#   labels:
#     vixens.io/sizing: "G-small"   # Guaranteed QoS - 50m/128Mi
#     vixens.io/sizing: "G-medium" # Guaranteed QoS - 200m/512Mi
#     vixens.io/sizing: "G-large"  # Guaranteed QoS - 1000m/2Gi
#     vixens.io/sizing: "G-xl"     # Guaranteed QoS - 2000m/4Gi
#
# PHASE: Enforce (mutation active)
# STATUS: Active for Orichalcum tier applications

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sizing-guaranteed
  annotations:
    policies.kyverno.io/title: Guaranteed QoS Sizing
    policies.kyverno.io/category: Resource Management
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Provides Guaranteed QoS resource sizing for Orichalcum tier applications.
      Requests equal limits to achieve Guaranteed QoS class.
      
      WARNING: Guaranteed QoS consumes more cluster resources (no overcommit).
      Most apps should use Burstable sizing (micro, small, medium, large, xlarge).
      Only use Guaranteed for critical apps requiring Orichalcum tier.
      
      Available sizes:
      - G-small:  50m CPU / 128Mi memory  (requests=limits)
      - G-medium: 200m CPU / 512Mi memory (requests=limits)
      - G-large:  1000m CPU / 2Gi memory (requests=limits)
      - G-xl:     2000m CPU / 4Gi memory (requests=limits)
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    # Rule 1: Guaranteed Small (G-small) - 50m/128Mi
    - name: guaranteed-small
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-small"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "50m"
                    memory: "128Mi"
                  limits:
                    cpu: "50m"
                    memory: "128Mi"

    # Rule 2: Guaranteed Medium (G-medium) - 200m/512Mi
    - name: guaranteed-medium
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-medium"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "200m"
                    memory: "512Mi"
                  limits:
                    cpu: "200m"
                    memory: "512Mi"

    # Rule 3: Guaranteed Large (G-large) - 1000m/2Gi
    - name: guaranteed-large
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-large"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "1000m"
                    memory: "2Gi"
                  limits:
                    cpu: "1000m"
                    memory: "2Gi"

    # Rule 4: Guaranteed XLarge (G-xl) - 2000m/4Gi
    - name: guaranteed-xlarge
      match:
        any:
          - resources:
              kinds:
                - Pod
              selector:
                matchLabels:
                  vixens.io/sizing: "G-xl"
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): "*"
                resources:
                  requests:
                    cpu: "2000m"
                    memory: "4Gi"
                  limits:
                    cpu: "2000m"
                    memory: "4Gi"
