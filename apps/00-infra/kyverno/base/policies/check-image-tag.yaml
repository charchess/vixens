---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-image-tag
  annotations:
    policies.kyverno.io/title: Disallow Latest Tag
    policies.kyverno.io/category: Maturity (Bronze)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: >-
      To ensure reproducibility and reliability, images should not use the ':latest' tag.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: validate-image-tag
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Using ':latest' tag is disallowed for maturity Level 1 (Bronze)."
        foreach:
          - list: "request.object.spec.containers"
            pattern:
              image: "!*:latest"
          - list: "request.object.spec.initContainers"
            pattern:
              image: "!*:latest"
