---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-infisical-secrets
  annotations:
    policies.kyverno.io/title: Require Infisical for Secrets
    policies.kyverno.io/category: Maturity (Silver)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: >-
      Audit if pods using secrets are correctly integrated with Infisical.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-secret-source
      match:
        any:
          - resources:
              kinds:
                - Pod
      preconditions:
        any:
        - key: "{{ request.object.spec.containers[].envFrom[].secretRef.name || '[]' | length(@) }}"
          operator: GreaterThan
          value: 0
      validate:
        message: "Secrets should be managed via Infisical for maturity Level 2 (Silver). Ensure InfisicalSecret is used."
        foreach:
          - list: "request.object.spec.containers[].envFrom[].secretRef"
            context:
              - name: secret_data
                apiCall:
                  urlPath: "/api/v1/namespaces/{{request.namespace}}/secrets/{{element.name}}"
                  jmesPath: "metadata.annotations."infisical.com/managed" || metadata.labels."app.kubernetes.io/managed-by" == 'infisical-operator' || 'false'"
            deny:
              conditions:
                all:
                - key: "{{ secret_data }}"
                  operator: Equals
                  value: "false"
