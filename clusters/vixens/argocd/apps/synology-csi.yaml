# clusters/vixens/argocd/apps/synology-csi.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: synology-csi
  namespace: argocd
spec:
  project: vixens
  source:
    # On pointe directement vers le dépôt Git qui contient le chart
    repoURL: https://github.com/zebernst/synology-csi-talos.git
    targetRevision: main
    # On indique le chemin vers le chart à l'intérieur du dépôt
    path: charts/synology-csi
    helm:
      values: |
        # On configure le secret directement via les values
        secret:
          create: true
          clientInfo:
            - address: "192.168.111.69"
              # Remplacez ces valeurs
              username: "VOTRE_USER_SYNOLOGY"
              password: "zNi2M.N}nUM%G*7"

        # On ajoute les tolerations pour que les pods puissent tourner
        controller:
          tolerations:
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"
        node:
          tolerations:
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"
  destination:
    server: https://kubernetes.default.svc
    namespace: synology-csi
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
