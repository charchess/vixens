{
  "project": {
    "name": "terraform-refactoring",
    "description": "Refactoring complet de l'infrastructure Terraform Vixens selon les best practices et le principe DRY",
    "metadata": {
      "priority": "high",
      "category": "infrastructure",
      "impact": "high",
      "estimated_duration": "6-8h",
      "breaking_change": true,
      "git_branch": "terraform-refactor",
      "documentation": "/root/vixens/docs/terraform-refactoring-implementation-plan.md",
      "status": "planned"
    },
    "objectives": [
      "Réduire le code de 35% (1400 → 900 lignes)",
      "Éliminer 100% des duplications",
      "Typer 100% des variables",
      "Passer de 3 à 2 niveaux d'architecture",
      "Sécuriser le backend S3"
    ],
    "success_criteria": [
      "terraform validate réussit sur tous les environnements",
      "terraform plan montre 'No changes' (idempotent)",
      "Test destroy/recreate réussi",
      "Aucun credential hardcodé",
      "Documentation complète et à jour"
    ]
  },
  "tasks": [
    {
      "id": "TFREF-000",
      "title": "Préparation et Sécurisation",
      "description": "Sécuriser l'infrastructure actuelle avant toute modification : backup state, création branche, snapshot infrastructure",
      "status": "todo",
      "priority": "critical",
      "estimated_duration": "15min",
      "assignee": null,
      "labels": ["preparation", "backup", "security"],
      "dependencies": [],
      "acceptance_criteria": [
        "State Terraform sauvegardé (fichier .backup présent)",
        "Branche terraform-refactor créée",
        "terraform plan montre 'No changes'",
        "Cluster Kubernetes opérationnel",
        "Tag git pre-refactor-YYYYMMDD créé"
      ],
      "implementation_steps": [
        "Backup local et remote state",
        "Créer branche git terraform-refactor",
        "Créer tag de sécurité pre-refactor-$(date +%Y%m%d)",
        "Exécuter terraform plan (doit être vide)",
        "Sauvegarder outputs et state list",
        "Valider santé du cluster (kubectl get nodes/pods)"
      ],
      "validation_commands": [
        "ls -lah terraform.tfstate.backup.*",
        "git branch | grep terraform-refactor",
        "terraform plan",
        "kubectl get nodes",
        "kubectl get pods -A"
      ],
      "rollback_procedure": "git checkout dev && git branch -D terraform-refactor",
      "blockers": [
        "terraform plan montre des changements non appliqués",
        "Cluster a des pods en erreur",
        "État git non propre"
      ],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-0-préparation"
      ]
    },
    {
      "id": "TFREF-001",
      "title": "Création Module Shared (DRY)",
      "description": "Créer un module central pour toutes les configurations communes et réutilisables : tolerations, versions, capabilities, labels",
      "status": "todo",
      "priority": "high",
      "estimated_duration": "30min",
      "assignee": null,
      "labels": ["module", "dry", "shared", "configuration"],
      "dependencies": ["TFREF-000"],
      "acceptance_criteria": [
        "Module shared/ créé avec 4 fichiers (locals.tf, outputs.tf, variables.tf, versions.tf)",
        "terraform validate réussit",
        "Test du module montre les outputs corrects",
        "Aucune duplication de code",
        "Documentation inline complète"
      ],
      "implementation_steps": [
        "Créer structure modules/shared/",
        "Créer versions.tf (aucun provider requis)",
        "Créer variables.tf (environment, loadbalancer_ip)",
        "Créer locals.tf avec chart_versions, control_plane_tolerations, cilium configs, env_config, common_labels, network, security, timeouts",
        "Créer outputs.tf avec exports de tous les locals",
        "Tester le module avec configuration temporaire",
        "Valider avec terraform validate"
      ],
      "validation_commands": [
        "cd modules/shared && terraform init && terraform validate",
        "terraform fmt",
        "Test module outputs"
      ],
      "files_created": [
        "modules/shared/locals.tf",
        "modules/shared/outputs.tf",
        "modules/shared/variables.tf",
        "modules/shared/versions.tf"
      ],
      "blockers": [
        "Module contient des ressources Terraform (doit être data-only)",
        "Validation échoue"
      ],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-1-création-module-shared"
      ]
    },
    {
      "id": "TFREF-002",
      "title": "Typage et Restructuration Variables",
      "description": "Transformer 27 variables plates non typées en 8 objets structurés avec validation stricte",
      "status": "todo",
      "priority": "high",
      "estimated_duration": "45min",
      "assignee": null,
      "labels": ["variables", "typing", "validation", "refactoring"],
      "dependencies": ["TFREF-001"],
      "acceptance_criteria": [
        "27 variables plates → 8 objets structurés",
        "100% des variables typées",
        "Validations sur formats (IP, versions, CIDR)",
        "Validation quorum etcd (nombre impair)",
        "terraform validate réussit"
      ],
      "implementation_steps": [
        "Backup ancien variables.tf et terraform.tfvars",
        "Créer nouveau variables.tf avec objets typés : environment, git_branch, cluster, control_plane_nodes, worker_nodes, argocd, cilium_l2, network, paths",
        "Créer nouveau terraform.tfvars avec valeurs structurées",
        "Ajouter validations (regex IP, CIDR, versions)",
        "Tester terraform validate (va échouer car main.tf pas encore migré - c'est normal)"
      ],
      "validation_commands": [
        "cd environments/dev",
        "terraform validate"
      ],
      "files_modified": [
        "environments/dev/variables.tf",
        "environments/dev/terraform.tfvars",
        "environments/test/variables.tf",
        "environments/test/terraform.tfvars",
        "environments/staging/variables.tf",
        "environments/staging/terraform.tfvars",
        "environments/prod/variables.tf",
        "environments/prod/terraform.tfvars"
      ],
      "objects_created": {
        "cluster": "name, endpoint, vip, talos_version, talos_image, kubernetes_version",
        "argocd": "service_type, loadbalancer_ip, hostname, insecure, disable_auth, anonymous_enabled",
        "cilium_l2": "pool_name, pool_ips, policy_name, interfaces, node_selector",
        "network": "vlan_services_subnet",
        "paths": "kubeconfig, talosconfig, cilium_ip_pool_yaml, cilium_l2_policy_yaml"
      },
      "blockers": [],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-2-typage-et-restructuration-variables"
      ]
    },
    {
      "id": "TFREF-003",
      "title": "Fusion et Optimisation Module ArgoCD",
      "description": "Fusionner base/argocd.tf et modules/argocd/main.tf en un seul module optimisé, éliminer toute duplication",
      "status": "todo",
      "priority": "high",
      "estimated_duration": "40min",
      "assignee": null,
      "labels": ["argocd", "module", "deduplication", "optimization"],
      "dependencies": ["TFREF-002"],
      "acceptance_criteria": [
        "Module ArgoCD optimisé avec objets typés",
        "Tolérations via variable (DRY)",
        "Annotations Cilium correctement gérées",
        "Aucune duplication de code",
        "Template path en variable"
      ],
      "implementation_steps": [
        "Analyser différences entre base/argocd.tf et modules/argocd/",
        "Optimiser modules/argocd/variables.tf avec objets typés",
        "Réécrire modules/argocd/main.tf : helm_release + kubectl_manifest root-app",
        "Utiliser control_plane_tolerations via variable (DRY)",
        "Ajouter annotations Cilium (io.cilium/lb-ipam-ips)",
        "Compléter modules/argocd/versions.tf si manquant"
      ],
      "validation_commands": [
        "cd modules/argocd",
        "terraform init -backend=false",
        "terraform validate"
      ],
      "files_modified": [
        "modules/argocd/variables.tf",
        "modules/argocd/main.tf",
        "modules/argocd/versions.tf"
      ],
      "duplication_eliminated": [
        "base/argocd.tf (180 lignes) vs modules/argocd/main.tf (147 lignes) → 1 module unique optimisé",
        "Tolerations répétées 6 fois → 1 variable"
      ],
      "blockers": [],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-3-fusion-et-optimisation-argocd"
      ]
    },
    {
      "id": "TFREF-004",
      "title": "Optimisation Module Cilium",
      "description": "Supprimer hardcoding et utiliser configurations du module shared (versions, capabilities, tolerations)",
      "status": "todo",
      "priority": "medium",
      "estimated_duration": "30min",
      "assignee": null,
      "labels": ["cilium", "module", "dry", "optimization"],
      "dependencies": ["TFREF-003"],
      "acceptance_criteria": [
        "Chart version en variable (plus de hardcoding)",
        "Capabilities via variables",
        "Tolerations DRY",
        "Timeout configurable",
        "terraform validate réussit"
      ],
      "implementation_steps": [
        "Optimiser modules/cilium/variables.tf : ajouter cilium_agent_capabilities, cilium_clean_capabilities, control_plane_tolerations, timeout",
        "Modifier modules/cilium/main.tf : chart_version via variable, securityContext.capabilities via variables, tolerations DRY",
        "Remplacer hardcoding par variables"
      ],
      "validation_commands": [
        "cd modules/cilium",
        "terraform init -backend=false",
        "terraform validate"
      ],
      "files_modified": [
        "modules/cilium/variables.tf",
        "modules/cilium/main.tf"
      ],
      "hardcoding_removed": [
        "chart_version = '1.18.3' → var.chart_version",
        "timeout = 600 → var.timeout",
        "capabilities hardcodées → var.cilium_agent_capabilities",
        "tolerations répétées 3 fois → var.control_plane_tolerations"
      ],
      "blockers": [],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-4-optimisation-module-cilium"
      ]
    },
    {
      "id": "TFREF-005",
      "title": "Suppression Module Base et Migration Architecture",
      "description": "Éliminer le niveau d'abstraction inutile (base/) et appeler directement les modules depuis environments/",
      "status": "todo",
      "priority": "critical",
      "estimated_duration": "60min",
      "assignee": null,
      "labels": ["architecture", "refactoring", "breaking-change"],
      "dependencies": ["TFREF-004"],
      "acceptance_criteria": [
        "terraform validate réussit",
        "terraform plan montre 'No changes' (CRITIQUE)",
        "Aucun appel au module base/",
        "Architecture à 2 niveaux (env → modules)",
        "Providers correctement configurés"
      ],
      "implementation_steps": [
        "Créer nouveau environments/dev/main.tf (60 lignes) : locals repo_root, module shared, module talos_cluster, local_files kubeconfig/talosconfig, wait_for_k8s_api, module cilium, module argocd, outputs",
        "Créer environments/dev/providers.tf (helm, kubectl, kubernetes)",
        "Créer/compléter environments/dev/versions.tf",
        "Backup répertoire base/ (ne pas supprimer immédiatement)",
        "Tester terraform init -upgrade",
        "VALIDATION CRITIQUE : terraform plan doit montrer 'No changes'"
      ],
      "validation_commands": [
        "cd environments/dev",
        "terraform init -upgrade",
        "terraform validate",
        "terraform plan -detailed-exitcode"
      ],
      "files_created": [
        "environments/dev/main.tf",
        "environments/dev/providers.tf",
        "environments/dev/versions.tf"
      ],
      "files_removed": [
        "terraform/base/ (tout le répertoire - après validation)"
      ],
      "critical_validation": "terraform plan DOIT montrer 'No changes' sinon STOP",
      "blockers": [
        "terraform plan montre des changements",
        "Ressources à détruire/recréer",
        "Providers mal configurés"
      ],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-5-suppression-du-module-base"
      ]
    },
    {
      "id": "TFREF-006",
      "title": "Sécurisation Backend S3",
      "description": "Supprimer credentials hardcodés du backend S3 et utiliser variables d'environnement",
      "status": "todo",
      "priority": "high",
      "estimated_duration": "15min",
      "assignee": null,
      "labels": ["security", "backend", "credentials"],
      "dependencies": ["TFREF-005"],
      "acceptance_criteria": [
        "Aucun credential hardcodé dans backend.tf",
        "Script helper créé et fonctionnel",
        "Documentation backend complète",
        "terraform init fonctionne avec env vars",
        "terraform state list réussit"
      ],
      "implementation_steps": [
        "Modifier environments/dev/backend.tf : supprimer access_key/secret_key, ajouter commentaires pour env vars",
        "Créer terraform/scripts/set-backend-credentials.sh",
        "Rendre script exécutable (chmod +x)",
        "Créer terraform/README-BACKEND.md avec documentation complète",
        "Tester : export vars, terraform init -reconfigure, terraform state list"
      ],
      "validation_commands": [
        "cd environments/dev",
        "export AWS_ACCESS_KEY_ID=terraform",
        "export AWS_SECRET_ACCESS_KEY=terraform",
        "terraform init -reconfigure",
        "terraform state list",
        "terraform plan"
      ],
      "files_modified": [
        "environments/dev/backend.tf",
        "environments/test/backend.tf",
        "environments/staging/backend.tf",
        "environments/prod/backend.tf"
      ],
      "files_created": [
        "terraform/scripts/set-backend-credentials.sh",
        "terraform/README-BACKEND.md"
      ],
      "security_improvements": [
        "Credentials hardcodés supprimés",
        "Variables d'environnement utilisées",
        "Script helper pour configuration",
        "Documentation sécurité complète"
      ],
      "blockers": [
        "Credentials env vars non configurés",
        "Backend Minio inaccessible"
      ],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-6-sécurisation-backend"
      ]
    },
    {
      "id": "TFREF-007",
      "title": "Validation Finale et Tests",
      "description": "Valider que le refactoring est complet, idempotent et fonctionnel. Tests destroy/recreate.",
      "status": "todo",
      "priority": "critical",
      "estimated_duration": "45min",
      "assignee": null,
      "labels": ["validation", "testing", "idempotence", "qa"],
      "dependencies": ["TFREF-006"],
      "acceptance_criteria": [
        "Tous les tests passent (validate, plan, destroy/recreate)",
        "Documentation mise à jour (CLAUDE.md)",
        "Métriques documentées (REFACTORING-METRICS.md)",
        "terraform plan = 'No changes' (idempotent)",
        "Cluster fonctionnel après recreate",
        "30-point checklist complétée"
      ],
      "implementation_steps": [
        "Validation syntaxique : terraform fmt -recursive sur tous les envs",
        "Validation modules : terraform validate sur shared, talos, cilium, argocd",
        "Test idempotence CRITIQUE : terraform plan -detailed-exitcode (exit code doit être 0)",
        "Test destroy/recreate (WARNING: détruit dev) : backup state, destroy, apply, validate cluster",
        "Créer terraform/REFACTORING-METRICS.md",
        "Mettre à jour CLAUDE.md (ajouter module shared, supprimer base/)",
        "Commit avec message détaillé",
        "Créer PR avec description complète"
      ],
      "validation_commands": [
        "terraform fmt -recursive",
        "for env in dev test staging prod; do cd environments/$env && terraform validate; done",
        "for module in shared talos cilium argocd; do cd modules/$module && terraform validate; done",
        "cd environments/dev && terraform plan -detailed-exitcode",
        "terraform destroy -auto-approve && terraform apply -auto-approve",
        "kubectl get nodes && kubectl get pods -A"
      ],
      "files_created": [
        "terraform/REFACTORING-METRICS.md"
      ],
      "files_modified": [
        "CLAUDE.md"
      ],
      "critical_tests": [
        "terraform plan exit code = 0 (No changes)",
        "Destroy/recreate success",
        "Cluster 3 nodes HA opérationnel",
        "ArgoCD accessible http://192.168.208.71",
        "Cilium CNI + LB IPAM fonctionnel"
      ],
      "checklist_30_points": [
        "terraform fmt -recursive sans changements",
        "terraform validate sur dev, test, staging, prod",
        "terraform plan sur dev = No changes",
        "Test destroy/recreate réussi",
        "Backend sécurisé (pas de credentials hardcodés)",
        "Documentation à jour (CLAUDE.md, README-BACKEND.md)",
        "Métriques documentées (REFACTORING-METRICS.md)",
        "Aucune duplication de code",
        "100% variables typées",
        "Module shared/ fonctionnel",
        "Répertoire base/ supprimé",
        "Script backend credentials fonctionnel",
        "PR description complète",
        "Tests CI/CD passent",
        "Review par pair"
      ],
      "blockers": [
        "terraform plan montre des changements",
        "Destroy/recreate échoue",
        "Cluster non opérationnel",
        "State corrompu"
      ],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-7-validation-finale"
      ]
    },
    {
      "id": "TFREF-008",
      "title": "Documentation et Communication",
      "description": "Finaliser la documentation, créer métriques, mettre à jour CLAUDE.md, préparer communication",
      "status": "todo",
      "priority": "medium",
      "estimated_duration": "30min",
      "assignee": null,
      "labels": ["documentation", "communication", "metrics"],
      "dependencies": ["TFREF-007"],
      "acceptance_criteria": [
        "CLAUDE.md mis à jour avec nouvelle architecture",
        "REFACTORING-METRICS.md créé avec métriques",
        "README-BACKEND.md complet",
        "Commit message détaillé",
        "PR description complète avec métriques"
      ],
      "implementation_steps": [
        "Créer REFACTORING-METRICS.md avec : code metrics, debt eliminated, DRY principle, validation results, best practices, maintainability score",
        "Mettre à jour CLAUDE.md : Repository Structure (supprimer base/), ajouter section Module Shared, mettre à jour commands",
        "Vérifier README-BACKEND.md complet",
        "Préparer commit message détaillé (breaking change, metrics, validation)",
        "Créer PR avec description complète"
      ],
      "validation_commands": [
        "git add .",
        "git commit -m 'refactor(terraform): DRY optimization and best practices'",
        "git push origin terraform-refactor",
        "gh pr create"
      ],
      "files_created": [
        "docs/REFACTORING-METRICS.md",
        "terraform/README-BACKEND.md"
      ],
      "files_modified": [
        "CLAUDE.md"
      ],
      "communication_items": [
        "Métriques de réussite (-35% code, -70% variables, -100% duplication)",
        "Breaking changes (architecture 3→2 niveaux)",
        "Migration guide",
        "Validation results (tests passed)",
        "Timeline de merge"
      ],
      "blockers": [],
      "documentation_refs": [
        "/root/vixens/docs/terraform-refactoring-implementation-plan.md#étape-7-validation-finale"
      ]
    }
  ],
  "timeline": {
    "estimated_total": "6-8h",
    "breakdown": {
      "TFREF-000": "15min",
      "TFREF-001": "30min",
      "TFREF-002": "45min",
      "TFREF-003": "40min",
      "TFREF-004": "30min",
      "TFREF-005": "60min",
      "TFREF-006": "15min",
      "TFREF-007": "45min",
      "TFREF-008": "30min"
    },
    "cumulative": {
      "TFREF-000": "15min",
      "TFREF-001": "45min",
      "TFREF-002": "1h30",
      "TFREF-003": "2h10",
      "TFREF-004": "2h40",
      "TFREF-005": "3h40",
      "TFREF-006": "3h55",
      "TFREF-007": "4h40",
      "TFREF-008": "5h10"
    }
  },
  "rollback_procedures": {
    "git": "git checkout pre-refactor-$(date +%Y%m%d) ou git reset --hard HEAD~1",
    "state": "Restaurer depuis terraform.tfstate.backup.YYYYMMDD_HHMMSS",
    "partial": "git checkout HEAD~1 -- terraform/environments/dev/main.tf"
  },
  "stop_conditions": [
    "terraform plan montre destruction de ressources",
    "State Terraform corrompu",
    "Cluster inaccessible après changements",
    "Tests destroy/recreate échouent"
  ],
  "metrics_targets": {
    "code_reduction": "-35% (1400 → 900 lignes)",
    "variables_reduction": "-70% (27 → 8 objets)",
    "duplication_elimination": "-100%",
    "typed_variables": "+100% (0% → 100%)",
    "architecture_simplification": "-33% (3 → 2 niveaux)"
  }
}
