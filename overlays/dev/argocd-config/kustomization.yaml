# overlays/dev/argocd-config/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/argocd-config

patches:
  # Patch 1 : On ajoute les données à la ConfigMap existante
  - target:
      kind: ConfigMap
      name: argocd-cmd-params-cm
    patch: |-
      - op: add
        path: /data/server.insecure
        value: "true"
      - op: add
        path: /data/server.disable.auth
        value: "true"
      - op: add
        path: /data/users.anonymous.enabled
        value: "true"
      - op: add
        path: /data/server.insecure.bind.address
        value: "0.0.0.0"
  
  # Patch 2 : On AJOUTE la section 'args' au Deployment, ce qui déclenche le redémarrage
  - target:
      kind: Deployment
      name: argocd-server
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/args
        value:
          - /usr/local/bin/argocd-server
          - --insecure
          - --disable-auth
