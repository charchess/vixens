machine en mode maintenance, on apply les configs
* talosctl apply-config --insecure --nodes 192.168.0.63   --file controlplane.yaml --config-patch @vixens-jade.yaml
* talosctl apply-config --insecure --nodes 192.168.0.65  --file controlplane.yaml --config-patch @vixens-emy.yaml
* talosctl apply-config --insecure --nodes 192.168.0.66  --file controlplane.yaml --config-patch @vixens-ruby.yaml

on defini le endpoint contacté par defaut lors des commandes talosctl :
* talosctl config endpoint 192.168.111.60

on verifie l'etat des membres
* talosctl --talosconfig talosconfig --nodes 192.168.111.63 get members


on configure les endpoints et node par defaut (devrait etre la vip je pense?) :
* talosctl --talosconfig talosconfig config endpoint 192.168.111.63
* talosctl --talosconfig talosconfig config node 192.168.111.63

on bootstrap un seul node ! :
* talosctl --nodes 192.168.111.63 bootstrap


on genere le kubeconfig :
* talosctl --nodes 192.168.111.60 kubeconfig .
* export KUBECONFIG=$(pwd)/kubeconfig

on installe cilium :
* helm install cilium cilium/cilium --version 1.18.1 \
  --namespace kube-system \
  -f manifests/cilium-values.yaml


installation de metallb :
* helm repo add metallb https://metallb.github.io/metallb
* helm repo update
* helm install metallb metallb/metallb \
  --namespace metallb-system --create-namespace \
  -f metallb-values.yaml
* kubectl apply -f manifests/metallb-config.yaml




installation de traefik :
* helm repo add traefik https://helm.traefik.io/traefik
* helm repo update
* helm install traefik traefik/traefik \
  --namespace traefik \
  --create-namespace \
  -f manifests/traefik-values.yaml \
  --set providers.kubernetesCRD.enabled=true \
  --set providers.kubernetesIngress.enabled=true
* kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v3.0/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml # pour ajouter les crds



installation de cert-manager :
* helm repo add jetstack https://charts.jetstack.io
* helm repo update
* helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --values manifests/cert-manager-values.yaml


installation webhook sintef/gandi
* helm repo add gandi-webhook https://sintef.github.io/cert-manager-webhook-gandi
* helm repo update
* helm install gandi-webhook gandi-webhook/cert-manager-webhook-gandi \
  --namespace cert-manager \
  --set gandiPat="42a2a1c56e29bbff391345eafe811e2e03ba0586" \
  --values manifests/cert-manager-webhook-gandi-values.yaml

on installe le clusterissuer :
* kubectl apply -f manifests/cert-manager-clusterissuer.yaml

	on mets en place le certificat pour homeassistant :
	* kubectl apply -f manifests/homeassistant-ingress-https.yaml


suppression des taints pour facilité de lab :
* kubectl taint nodes --all node-role.kubernetes.io/control-plane:NoSchedule-




installation iscsi :
* upgrade du node (v1.11.0, iscsi-tools, linux-tools) :  
  talosctl upgrade --nodes <IP_DU_NŒUD> \
  --image  factory.talos.dev/metal-installer/613e1592b2da41ae5e265e8789429f22e121aab91cb4deb6bc3c0b6262961245:v1.11.0  \
  --preserve

installation de rook :
* helm repo add rook-release https://charts.rook.io/release
* helm repo update
export ROOK_NS="rook-ceph"
export ROOK_VERSION="v1.18.0"       # <- choisis la dernière stable
export HELM_REPO="rook-release"
helm upgrade --install rook-ceph "$HELM_REPO/rook-ceph" \
  --namespace "$ROOK_NS" \
  --values manifests/rook-operator-values.yaml \
  --version "$ROOK_VERSION"
helm upgrade --install rook-ceph-cluster "$HELM_REPO/rook-ceph-cluster" \
  --namespace "$ROOK_NS" \
  --values rook-cluster-values.yaml \
  --version "$ROOK_VERSION"








installation de argoCD
* helm repo add argo https://argoproj.github.io/argo-helmhelm 
* repo update
* helm upgrade --install argocd argo/argo-cd --version 8.3.1 --namespace argocd --create-namespace
* kubectl apply -f clusters/vixens/argocd/01-vixens-root.yaml
(si c'est long, virer les taints !!!!)


* kubectl apply -f manifests/argocd-ingress.yaml ?
* recuperation du mot de passe : kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
