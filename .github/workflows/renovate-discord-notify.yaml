---
name: Renovate Discord Notifications

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled, closed]
    branches: [dev]

jobs:
  notify-discord:
    name: Notify Discord on Renovate PR
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'renovate')

    steps:
      - name: Extract PR metadata
        id: metadata
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "pr_url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "pr_state=${{ github.event.pull_request.state }}" >> $GITHUB_OUTPUT

          # Detect update type (major/minor/patch)
          if echo "${{ github.event.pull_request.title }}" | grep -q "(major)"; then
            echo "update_type=major" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red
          elif echo "${{ github.event.pull_request.title }}" | grep -q "(minor)"; then
            echo "update_type=minor" >> $GITHUB_OUTPUT
            echo "color=16776960" >> $GITHUB_OUTPUT  # Yellow
          else
            echo "update_type=patch" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT   # Green
          fi

          # Check if approved (has 'approved' label)
          if echo "${{ join(github.event.pull_request.labels.*.name, ',') }}" | grep -q "approved"; then
            echo "is_approved=true" >> $GITHUB_OUTPUT
          else
            echo "is_approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification (New PR)
        if: github.event.action == 'opened'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RENOVATE }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üîî New Renovate Update Available",
                "description": "${{ steps.metadata.outputs.pr_title }}",
                "url": "${{ steps.metadata.outputs.pr_url }}",
                "color": ${{ steps.metadata.outputs.color }},
                "fields": [
                  {
                    "name": "PR Number",
                    "value": "#${{ steps.metadata.outputs.pr_number }}",
                    "inline": true
                  },
                  {
                    "name": "Update Type",
                    "value": "${{ steps.metadata.outputs.update_type }}",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "‚è≥ Awaiting Approval",
                    "inline": true
                  },
                  {
                    "name": "Action Required",
                    "value": "Review the PR and add **approved** label to auto-merge",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Vixens GitOps - Renovate Bot"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }],
              "components": [{
                "type": 1,
                "components": [
                  {
                    "type": 2,
                    "style": 5,
                    "label": "View PR",
                    "url": "${{ steps.metadata.outputs.pr_url }}"
                  },
                  {
                    "type": 2,
                    "style": 5,
                    "label": "Approve & Merge",
                    "url": "${{ steps.metadata.outputs.pr_url }}/files"
                  }
                ]
              }]
            }'

      - name: Send Discord notification (Approved)
        if: |
          github.event.action == 'labeled' &&
          github.event.label.name == 'approved'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RENOVATE }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚úÖ Renovate PR Approved",
                "description": "${{ steps.metadata.outputs.pr_title }}",
                "url": "${{ steps.metadata.outputs.pr_url }}",
                "color": 3066993,
                "fields": [
                  {
                    "name": "PR Number",
                    "value": "#${{ steps.metadata.outputs.pr_number }}",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "‚úÖ Approved - Auto-merging",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Vixens GitOps - Renovate Bot"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

      - name: Send Discord notification (Merged)
        if: |
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RENOVATE }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ Renovate PR Merged & Deployed",
                "description": "${{ steps.metadata.outputs.pr_title }}",
                "url": "${{ steps.metadata.outputs.pr_url }}",
                "color": 5763719,
                "fields": [
                  {
                    "name": "PR Number",
                    "value": "#${{ steps.metadata.outputs.pr_number }}",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "üöÄ Deployed to Dev Cluster",
                    "inline": true
                  },
                  {
                    "name": "ArgoCD Sync",
                    "value": "Wait 5-10 minutes for auto-sync",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Vixens GitOps - Renovate Bot"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

      - name: Send Discord notification (Closed without merge)
        if: |
          github.event.action == 'closed' &&
          github.event.pull_request.merged == false
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RENOVATE }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Renovate PR Closed",
                "description": "${{ steps.metadata.outputs.pr_title }}",
                "url": "${{ steps.metadata.outputs.pr_url }}",
                "color": 10038562,
                "fields": [
                  {
                    "name": "PR Number",
                    "value": "#${{ steps.metadata.outputs.pr_number }}",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "‚ùå Closed without merging",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Vixens GitOps - Renovate Bot"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

  auto-merge:
    name: Auto-merge approved Renovate PRs
    runs-on: ubuntu-latest
    needs: notify-discord
    if: |
      github.event.action == 'labeled' &&
      github.event.label.name == 'approved' &&
      contains(github.event.pull_request.labels.*.name, 'renovate')

    steps:
      - name: Wait for CI checks
        run: sleep 30

      - name: Auto-merge PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --squash \
            --auto \
            --delete-branch
