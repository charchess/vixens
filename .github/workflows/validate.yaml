---
name: Validate & Security

on:
  push:
    branches: [dev, main]
  pull_request:

jobs:
  # 1ï¸âƒ£ Validation YAML robuste
  yaml-lint:
    name: YAML Syntax & Style
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup yamllint
        run: |
          sudo apt-get update && sudo apt-get install -y yamllint

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validation YAML syntax"

          # CrÃ©ation du fichier ligne par ligne
          echo "---" > yamllint-config.yml
          echo "extends: default" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "yaml-files:" >> yamllint-config.yml
          echo "  - '*.yaml'" >> yamllint-config.yml
          echo "  - '*.yml'" >> yamllint-config.yml
          echo "  - '.yamllint'" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "rules:" >> yamllint-config.yml
          echo "  # ============ ERREURS CRITIQUES ============" >> yamllint-config.yml
          echo "  indentation:" >> yamllint-config.yml
          echo "    spaces: 2" >> yamllint-config.yml
          echo "    indent-sequences: true" >> yamllint-config.yml
          echo "    check-multi-line-strings: false" >> yamllint-config.yml
          echo "    level: error" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  key-duplicates:" >> yamllint-config.yml
          echo "    level: error" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  # ============ WARNINGS ============" >> yamllint-config.yml
          echo "  line-length:" >> yamllint-config.yml
          echo "    max: 80" >> yamllint-config.yml
          echo "    allow-non-breakable-words: true" >> yamllint-config.yml
          echo "    allow-non-breakable-inline-mappings: true" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  trailing-spaces:" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  new-lines:" >> yamllint-config.yml
          echo "    type: unix" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  # ============ DÃ‰SACTIVÃ‰ES ============" >> yamllint-config.yml
          echo "  comments: disable" >> yamllint-config.yml
          echo "  comments-indentation: disable" >> yamllint-config.yml
          echo "  brackets: disable" >> yamllint-config.yml
          echo "  truthy: disable" >> yamllint-config.yml


          # PR: valider uniquement les fichiers changÃ©s
          # Push: valider tous les fichiers
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ðŸ“‹ PR Mode: Validating only changed files"
            gh pr view ${{ github.event.pull_request.number }} \
              --json files --jq '.files.[].path' | \
              grep -E '\.(yaml|yml)$' | \
              grep -E '^(apps|argocd)/' | \
              grep -v -E '(crds/|charts/|upstream\.yaml|poolers\.yaml)' | \
              xargs -r yamllint -c yamllint-config.yml || true
          else
            echo "ðŸ“‹ Push Mode: Validating all files"
            find apps argocd \( -name "*.yaml" -o -name "*.yml" \) \
              ! -path "*/crds/*" \
              ! -path "*/charts/*" \
              ! -name "upstream.yaml" \
              ! -name "poolers.yaml" | \
              xargs yamllint -c yamllint-config.yml
          fi

  # 2ï¸âƒ£ Validation structurelle Kubernetes
  kube-structure:
    name: Kubernetes Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubeval (sans kubectl)
        run: |
          # Installation de kubeval avec schÃ©mas complets
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo cp kubeval /usr/local/bin/

      - name: Validate with kubeval (CRDs ignorÃ©es)
        run: |
          echo "ðŸ” Validation structure Kubernetes"

          # Valider uniquement les ressources standards (exclure values/ et charts/)
          find apps argocd -type f \( -name '*.yaml' -o -name '*.yml' \) \
            ! -path '*/values/*' \
            ! -path '*/charts/*' \
            ! -path '*/patches/*' \
            ! -name 'values.yaml' \
            ! -name '*patch.yaml' \
            -print0 |
            xargs -0 kubeval \
            --ignore-missing-schemas \
            --kubernetes-version 1.30.0 \
            --strict \
            --skip-kinds Application,AppProject,CustomResourceDefinition,InfisicalSecret,Middleware,HelmRelease,HelmRepository,Kustomization,Cluster,PostgresCluster,Pooler,ScheduledBackup,Component

  # 3ï¸âƒ£ Validation spÃ©cifique ArgoCD
  argocd-validate:
    name: ArgoCD Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup yq
        uses: mikefarah/yq@v4.44.1

      - name: Validate ArgoCD applications
        run: |
          echo "ðŸ” Validation Applications ArgoCD"

          # Validation complÃ¨te des Applications
          find argocd -name "*.yaml" -type f | while read file; do
            if [ "$(yq eval '.kind' "$file" 2>/dev/null)" = "Application" ]; then
              echo "ðŸ“‹ Validation: $(basename "$file")"

              # VÃ©rification dÃ©taillÃ©e
              yq eval '
                .apiVersion == "argoproj.io/v1alpha1" and
                .kind == "Application" and
                .metadata.name != null and
                .metadata.name != "" and
                .spec.project != null and
                .spec.project != "" and
                .spec.source.repoURL != null and
                .spec.source.repoURL != "" and
                .spec.source.path != null and
                .spec.source.path != "" and
                .spec.destination.server != null and
                .spec.destination.server != "" and
                .spec.destination.namespace != null and
                .spec.destination.namespace != ""
              ' "$file" || {
                echo "âŒ Structure ArgoCD invalide: $file"
                yq eval '.' "$file"  # Afficher le contenu pour debugging
                exit 1
              }
            fi
          done

  # 4ï¸âƒ£Â½  VÃ©rification du flux de branches (pure trunk-based: feature â†’ main)
  branch-flow:
    name: Branch Flow Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Enforce pure trunk-based flow (feature â†’ main directly)
        run: |
          # Branche source de la PR
          SOURCE="${{ github.head_ref }}"
          # Branche cible de la PR
          TARGET="${{ github.base_ref }}"

          echo "ðŸ”€ PR from '$SOURCE' into '$TARGET'"

          case "$TARGET" in
            main)
              # Feature branches allowed, protected branches blocked
              if [[ "$SOURCE" =~ ^(dev|test|staging)$ ]]; then
                echo "âŒ Protected branch '$SOURCE' cannot merge to 'main'"
                echo "   Only feature branches can merge to main"
                echo "   Note: dev/test/staging branches are archived (ADR-017)"
                exit 1
              fi
              echo "âœ… Feature branch '$SOURCE' allowed to merge into 'main'"
              exit 0 ;;
            dev|test|staging)
              echo "âŒ Branch '$TARGET' is archived (ADR-017)"
              echo "   Use pure trunk-based workflow: feature â†’ main"
              echo "   Dev watches main (HEAD), Prod watches prod-stable tag"
              exit 1 ;;
            *)
              echo "âŒ Unknown target branch '$TARGET'"
              exit 1 ;;
          esac

  # 4ï¸âƒ£ Validation de sÃ©curitÃ©
  security-scan:
    name: Security Best Practices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security checks
        run: |
          echo "ðŸ” VÃ©rification sÃ©curitÃ©"

          # Installation de checkov
          pip3 install checkov

          # Scan des bonnes pratiques
          checkov --directory . \
            --framework kubernetes \
            --compact --quiet || true

      - name: Check security patterns
        run: |
          echo "ðŸ” Recherche de patterns de sÃ©curitÃ©"

          # VÃ©rification des patterns dangereux
          find apps argocd -name "*.yaml" -type f | while read file; do
            echo "  ðŸ“„ $(basename "$file")"

            # Recherche de patterns problÃ©matiques
            if grep -q "privileged: true" "$file"; then
              echo "    âš ï¸ PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s"
            fi

            if grep -q "runAsUser: 0\|runAsRoot: true" "$file"; then
              echo "    âš ï¸ ExÃ©cution en root dÃ©tectÃ©e"
            fi

            if grep -q "allowPrivilegeEscalation: true" "$file"; then
              echo "    âš ï¸ Ã‰lÃ©vation de privilÃ¨ges autorisÃ©e"
            fi
          done

  # 4ï¸âƒ£Â½  VÃ©rification de la configuration production (trunk-based)
  prod-config-check:
    name: "Production Configuration Checks"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "Verify trunk-based workflow compliance"
        run: |
          echo "ðŸ” VÃ©rification configuration production (trunk-based workflow)"

          # Trunk-based: prod doit utiliser targetRevision: prod-stable (tag mobile)
          # VÃ©rifier qu'on n'utilise pas 'main' ou 'prod' comme targetRevision
          if grep -rE "targetRevision:\s+main\s*$" argocd/overlays/prod; then
            echo "::error::Found 'targetRevision: main' in argocd/overlays/prod."
            echo "::error::Trunk-based workflow requires 'targetRevision: prod-stable' for production."
            exit 1
          fi

          # Rejeter 'prod' seul (pas 'prod-stable' ou 'prod-v1.2.3')
          # Gemini suggÃ¨re souvent targetRevision: prod Ã  tort
          if grep -rE "targetRevision:\s+[\"']?prod[\"']?\s*$" argocd/overlays/prod; then
            echo "::error::Found 'targetRevision: prod' in argocd/overlays/prod."
            echo "::error::Trunk-based workflow requires 'targetRevision: prod-stable' for production."
            echo "::error::Note: 'prod' branch does not exist. Use 'prod-stable' tag instead."
            exit 1
          fi

          # VÃ©rifier que prod utilise bien envSlug: prod (pas dev)
          if grep -r "envSlug: dev" apps/*/*/overlays/prod; then
            echo "::error::Found 'envSlug: dev' in apps/*/*/overlays/prod. Please use 'prod' for production."
            exit 1
          fi

          # VÃ©rifier absence de rÃ©fÃ©rences au repo deprecated
          if grep -r "vixens-new.git" argocd; then
            echo "::error::Found 'vixens-new.git references' in argocd. Please use 'vixens.git', vixens-new is deprecated."
            exit 1
          fi

          echo "âœ… Production configuration compliant with trunk-based workflow"

  # 5ï¸âƒ£ RÃ©sumÃ© final
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, kube-structure, argocd-validate, security-scan, branch-flow, prod-config-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## âœ… Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| K8s Structure | ${{ needs.kube-structure.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Apps | ${{ needs.argocd-validate.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-scan.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Branch Flow | ${{ needs.branch-flow.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Prod Config Check | ${{ needs.prod-config-check.result }} |" \
            >> $GITHUB_STEP_SUMMARY
