name: Validate & Security

on:
  push:
    branches: [ main ]
    paths:
      - '**.yaml'
      - '**.yml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - '**.yaml'
      - '**.yml'

jobs:
  # 1ï¸âƒ£ Validation YAML basique (fonctionne toujours)
  yaml-lint:
    name: YAML Syntax & Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: karancode/yamllint-github-action@master
        with:
          yamllint_strict: false
          yamllint_comment: true
          yamllint_config_filepath: .yamllint.yml

  # 2ï¸âƒ£ Validation avec kubectl uniquement (remplace kubeval)
  kubectl-validate:
    name: kubectl dry-run validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0'

      - name: Validate manifests by category
        run: |
          echo "ðŸ” Validation des manifests Kubernetes"
          
          # Validation des manifests standards (sans CRDs)
          for category in namespace service deployment ingress; do
            files=$(find base -name "*${category}*.yaml" -type f 2>/dev/null)
            if [ -n "$files" ]; then
              echo "ðŸ“ Validation des $category manifests:"
              echo "$files" | while read file; do
                echo "  ðŸ“„ $file"
                kubectl apply --dry-run=client -f "$file" || {
                  echo "âŒ Erreur dans $file"
                  exit 1
                }
              done
            fi
          done

      - name: Validate ArgoCD applications
        run: |
          echo "ðŸ” Validation des Applications ArgoCD"
          
          # Valider la structure des Applications ArgoCD
          find clusters -name "*.yaml" -type f | while read file; do
            if grep -q "kind: Application" "$file"; then
              echo "ðŸ“‹ Validation de $file"
              
              # VÃ©rifier la structure minimale avec yq
              yq eval '
                .apiVersion == "argoproj.io/v1alpha1" and
                .kind == "Application" and
                .metadata.name and
                .spec.project and
                .spec.source.repoURL and
                .spec.source.path and
                .spec.destination.server and
                .spec.destination.namespace
              ' "$file" || {
                echo "âŒ Structure ArgoCD invalide: $file"
                exit 1
              }
            fi
          done

  # 3ï¸âƒ£ Validation structurelle avancÃ©e
  structure-validate:
    name: Structure & Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update && sudo apt-get install -y yq

      - name: Validate resource structure
        run: |
          echo "ðŸ” Validation structurelle"
          
          # VÃ©rification des namespaces rÃ©fÃ©rencÃ©s
          echo "ðŸ“‹ VÃ©rification des namespaces"
          find base -name "*.yaml" -type f | while read file; do
            namespace=$(yq eval '.metadata.namespace' "$file")
            if [ "$namespace" != "null" ] && [ "$namespace" != "" ]; then
              namespace_file="base/${namespace}/namespace.yaml"
              if [ ! -f "$namespace_file" ]; then
                echo "âš ï¸ Namespace $namespace rÃ©fÃ©rencÃ© mais pas dÃ©fini dans $file"
              fi
            fi
          done

      - name: Validate ingress targets
        run: |
          echo "ðŸ” Validation des ingress"
          
          # VÃ©rifier que les services rÃ©fÃ©rencÃ©s dans les ingress existent
          find base -name "*ingress*.yaml" -type f | while read ingress; do
            service=$(yq eval '.spec.rules[0].http.paths[0].backend.service.name' "$ingress")
            namespace=$(yq eval '.metadata.namespace' "$ingress")
            echo "  ðŸ“¡ Ingress: $(basename $ingress) -> Service: $service"
            
            # VÃ©rifier l'existence du service (approximatif)
            if [ "$service" != "null" ]; then
              service_file="base/*/${service}.yaml"
              if ! find base -name "${service}.yaml" -type f | grep -q .; then
                echo "âš ï¸ Service $service rÃ©fÃ©rencÃ© mais peut ne pas exister"
              fi
            fi
          done

  # 4ï¸âƒ£ Validation de sÃ©curitÃ© simplifiÃ©e
  security-check:
    name: Security Best Practices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check security best practices
        run: |
          echo "ðŸ” VÃ©rification des bonnes pratiques de sÃ©curitÃ©"
          
          # VÃ©rifier les privilÃ¨ges Ã©levÃ©s
          find base -name "*.yaml" -type f | while read file; do
            if grep -q "privileged: true" "$file"; then
              echo "âš ï¸ PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s: $file"
            fi
            
            if grep -q "runAsRoot\|runAsUser: 0" "$file"; then
              echo "âš ï¸ ExÃ©cution en root dÃ©tectÃ©e: $file"
            fi
          done

  # 5ï¸âƒ£ GÃ©nÃ©ration de rapport
  report:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, kubectl-validate, structure-validate, security-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "# âœ… Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| kubectl Validation | ${{ needs.kubectl-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure | ${{ needs.structure-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-check.result }} |" >> $GITHUB_STEP_SUMMARY
