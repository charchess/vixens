---
name: Validate & Security

on:
  push:
    branches: [dev, test, staging, main]
  pull_request:

jobs:
  # 1ï¸âƒ£ Validation YAML robuste
  yaml-lint:
    name: YAML Syntax & Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup yamllint
        run: |
          sudo apt-get update && sudo apt-get install -y yamllint

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validation YAML syntax"

          # Configuration yamllint inline
      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validation YAML syntax"

          # CrÃ©ation du fichier ligne par ligne
          echo "---" > yamllint-config.yml
          echo "extends: default" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "yaml-files:" >> yamllint-config.yml
          echo "  - '*.yaml'" >> yamllint-config.yml
          echo "  - '*.yml'" >> yamllint-config.yml
          echo "  - '.yamllint'" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "rules:" >> yamllint-config.yml
          echo "  # ============ ERREURS CRITIQUES ============" >> yamllint-config.yml
          echo "  indentation:" >> yamllint-config.yml
          echo "    spaces: 2" >> yamllint-config.yml
          echo "    indent-sequences: true" >> yamllint-config.yml
          echo "    check-multi-line-strings: false" >> yamllint-config.yml
          echo "    level: error" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  key-duplicates:" >> yamllint-config.yml
          echo "    level: error" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  # ============ WARNINGS ============" >> yamllint-config.yml
          echo "  line-length:" >> yamllint-config.yml
          echo "    max: 80" >> yamllint-config.yml
          echo "    allow-non-breakable-words: true" >> yamllint-config.yml
          echo "    allow-non-breakable-inline-mappings: true" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  trailing-spaces:" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  new-lines:" >> yamllint-config.yml
          echo "    type: unix" >> yamllint-config.yml
          echo "    level: warning" >> yamllint-config.yml
          echo "" >> yamllint-config.yml
          echo "  # ============ DÃ‰SACTIVÃ‰ES ============" >> yamllint-config.yml
          echo "  comments: disable" >> yamllint-config.yml
          echo "  comments-indentation: disable" >> yamllint-config.yml
          echo "  brackets: disable" >> yamllint-config.yml
          echo "  truthy: disable" >> yamllint-config.yml

          # Valider tous les fichiers YAML pertinents
          find apps argocd -name "*.yaml" -o -name "*.yml" | \
            xargs yamllint -c yamllint-config.yml

  # 2ï¸âƒ£ Validation structurelle Kubernetes
  kube-structure:
    name: Kubernetes Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubeval (sans kubectl)
        run: |
          # Installation de kubeval avec schÃ©mas complets
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo cp kubeval /usr/local/bin/

      - name: Validate with kubeval (CRDs ignorÃ©es)
        run: |
          echo "ðŸ” Validation structure Kubernetes"

          # Valider uniquement les ressources standards
          find apps argocd -type f \( -name '*.yaml' -o -name '*.yml' \) -print0 |
            xargs -0 kubeval \
            --ignore-missing-schemas \
            --kubernetes-version 1.30.0 \
            --strict \
            --skip-kinds Application,AppProject,CustomResourceDefinition

  # 3ï¸âƒ£ Validation spÃ©cifique ArgoCD
  argocd-validate:
    name: ArgoCD Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup yq
        uses: mikefarah/yq@v4.44.1

      - name: Validate ArgoCD applications
        run: |
          echo "ðŸ” Validation Applications ArgoCD"

          # Validation complÃ¨te des Applications
          find argocd -name "*.yaml" -type f | while read file; do
            if [ "$(yq eval '.kind' "$file" 2>/dev/null)" = "Application" ]; then
              echo "ðŸ“‹ Validation: $(basename "$file")"

              # VÃ©rification dÃ©taillÃ©e
              yq eval '
                .apiVersion == "argoproj.io/v1alpha1" and
                .kind == "Application" and
                .metadata.name != null and
                .metadata.name != "" and
                .spec.project != null and
                .spec.project != "" and
                .spec.source.repoURL != null and
                .spec.source.repoURL != "" and
                .spec.source.path != null and
                .spec.source.path != "" and
                .spec.destination.server != null and
                .spec.destination.server != "" and
                .spec.destination.namespace != null and
                .spec.destination.namespace != ""
              ' "$file" || {
                echo "âŒ Structure ArgoCD invalide: $file"
                yq eval '.' "$file"  # Afficher le contenu pour debugging
                exit 1
              }
            fi
          done

  # 4ï¸âƒ£Â½  VÃ©rification du flux de branches
  branch-flow:
    name: Branch Flow Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Enforce promotion order  (dev â†’ test â†’ staging â†’ main)
        run: |
          # Branche source de la PR
          SOURCE="${{ github.head_ref }}"
          # Branche cible de la PR
          TARGET="${{ github.base_ref }}"

          echo "ðŸ”€ PR from '$SOURCE' into '$TARGET'"

          case "$TARGET" in
            test)
              [ "$SOURCE" = "dev" ] && exit 0 ;;
            staging)
              [ "$SOURCE" = "test" ] && exit 0 ;;
            main)
              [ "$SOURCE" = "staging" ] && exit 0 ;;
            dev)
              # Allow feature branches to merge into dev
              # Block environment branches (test, staging, main) from merging to dev
              if [[ "$SOURCE" =~ ^(test|staging|main)$ ]]; then
                echo "âŒ Environment branch '$SOURCE' cannot merge to 'dev'"
                echo "   Use promotion flow: devâ†’testâ†’stagingâ†’main"
                exit 1
              fi
              echo "âœ… Feature branch '$SOURCE' allowed to merge into 'dev'"
              exit 0 ;;
            *)
              echo "âŒ Unknown target branch '$TARGET'"
              exit 1 ;;
          esac

          echo "âŒ Promotion interdite : $SOURCE â†’ $TARGET"
          echo "   Seuls devâ†’test, testâ†’staging, stagingâ†’main sont autorisÃ©s."
          exit 1

  # 4ï¸âƒ£ Validation de sÃ©curitÃ©
  security-scan:
    name: Security Best Practices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security checks
        run: |
          echo "ðŸ” VÃ©rification sÃ©curitÃ©"

          # Installation de checkov
          pip3 install checkov

          # Scan des bonnes pratiques
          checkov --directory . \
            --framework kubernetes \
            --compact --quiet || true

      - name: Check security patterns
        run: |
          echo "ðŸ” Recherche de patterns de sÃ©curitÃ©"

          # VÃ©rification des patterns dangereux
          find apps argocd -name "*.yaml" -type f | while read file; do
            echo "  ðŸ“„ $(basename "$file")"

            # Recherche de patterns problÃ©matiques
            if grep -q "privileged: true" "$file"; then
              echo "    âš ï¸ PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s"
            fi

            if grep -q "runAsUser: 0\|runAsRoot: true" "$file"; then
              echo "    âš ï¸ ExÃ©cution en root dÃ©tectÃ©e"
            fi

            if grep -q "allowPrivilegeEscalation: true" "$file"; then
              echo "    âš ï¸ Ã‰lÃ©vation de privilÃ¨ges autorisÃ©e"
            fi
          done

  # 5ï¸âƒ£ RÃ©sumÃ© final
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, kube-structure, argocd-validate, security-scan, branch-flow]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## âœ… Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| K8s Structure | ${{ needs.kube-structure.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Apps | ${{ needs.argocd-validate.result }} |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-scan.result }} |" \
            >> $GITHUB_STEP_SUMMARY
